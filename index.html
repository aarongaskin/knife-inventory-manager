<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">
    <title>Knife Inventory Manager v30 - Advanced Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .nav-tabs { display: flex; flex-wrap: wrap; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .nav-tabs button { background: none; border: none; padding: 15px 20px; font-size: 14px; font-weight: 500; cursor: pointer; color: #666; transition: all 0.3s ease; border-bottom: 3px solid transparent; white-space: nowrap; }
        .nav-tabs button:hover { background: #e8e8e8; color: #667eea; }
        .nav-tabs button.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .tab-section h2 { color: #333; margin-bottom: 20px; font-size: 1.8em; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .tab-section p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .inventory-controls { background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .inventory-controls h3 { width: 100%; color: #2e7d32; margin-bottom: 15px; }
        .sheet-controls { background: #f0f4ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .sheet-status { display: inline-flex; align-items: center; gap: 8px; padding: 12px 15px; border-radius: 6px; font-weight: 500; }
        .sheet-status.inactive { background: #f5f5f5; color: #666; }
        .sheet-status.active { background: #c8e6c9; color: #2e7d32; }
        .sheet-status.completed { background: #bbdefb; color: #1565c0; }
        .sheet-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; font-size: 13px; }
        .sheet-btn:hover { background: #5568d3; }
        .sheet-btn.lock-btn { background: #ff9800; }
        .sheet-btn.lock-btn:hover { background: #fb8c00; }
        .sheet-btn.unlock-btn { background: #4caf50; }
        .sheet-btn.unlock-btn:hover { background: #45a049; }
        .event-checkbox { display: flex; align-items: center; gap: 10px; }
        .event-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .event-checkbox label { font-weight: 500; color: #333; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        thead { background: #667eea; color: white; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { font-weight: 600; }
        tbody tr:hover { background: #f8f9fa; }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        input[readonly] { background-color: #f8f9fa; color: #666; cursor: not-allowed; }
        input:disabled { background-color: #f5f5f5; color: #999; cursor: not-allowed; }
        select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        .revenue-row { font-weight: 700; background: #fffacd; border-top: 2px solid #667eea; }
        .units-sold-row { font-weight: 700; background: #e8f5e9; }
        .total-row { font-weight: 700; background: #eef2ff; }
        .summary-row { font-weight: 600; background: #f5e6cc; }
        .nav-links { background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .nav-link { display: inline-block; margin-right: 15px; margin-bottom: 10px; padding: 10px 15px; background: white; border: 2px solid #667eea; color: #667eea; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .nav-link:hover { background: #667eea; color: white; }
        .nav-link.reset-btn { background: #ff6b6b; color: white; border-color: #ff6b6b; }
        .nav-link.export-btn { background: #4caf50; color: white; border-color: #4caf50; }
        .nav-link.export-btn:hover { background: #45a049; }
        .nav-link.import-btn { background: #2196f3; color: white; border-color: #2196f3; }
        .nav-link.import-btn:hover { background: #1976d2; }
        .refresh-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 15px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin-bottom: 20px; }
        .refresh-btn:hover { background: #1976d2; }
        .refresh-btn::before { content: '‚Üª'; font-size: 16px; }
        .remove-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 15px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin-bottom: 20px; }
        .remove-btn:hover { background: #ff5252; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #333; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .modal-buttons .btn-cancel { background: #e0e0e0; color: #333; }
        .modal-buttons .btn-cancel:hover { background: #d0d0d0; }
        .modal-buttons .btn-create { background: #667eea; color: white; }
        .modal-buttons .btn-create:hover { background: #5568d3; }
        .modal-buttons .btn-add-inventory { background: #4caf50; color: white; }
        .modal-buttons .btn-add-inventory:hover { background: #45a049; }
        .modal-buttons .btn-remove { background: #ff6b6b; color: white; }
        .modal-buttons .btn-remove:hover { background: #ff5252; }
        .modal-buttons .btn-import { background: #2196f3; color: white; }
        .modal-buttons .btn-import:hover { background: #1976d2; }
        .inventory-table { width: 100%; border-collapse: collapse; }
        .inventory-table thead { background: #4caf50; }
        .inventory-table th, .inventory-table td { padding: 10px; text-align: left; border: 1px solid #ddd; }
        .inventory-table input { margin: 0; padding: 5px; }
        .flow-info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3; font-size: 13px; color: #1565c0; line-height: 1.6; }
        .depletion-notice { background: #c8e6c9; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; color: #2e7d32; font-size: 12px; font-weight: 500; border-left: 4px solid #4caf50; }
        .success-banner { background: #4caf50; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; text-align: center; font-weight: 500; }
        .success-banner.show { display: block; }
        .aggregation-info { background: #fff3cd; padding: 12px 15px; border-radius: 5px; margin-bottom: 15px; color: #856404; font-size: 12px; border-left: 4px solid #ffc107; }
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .chart-container { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .chart-container h3 { margin-bottom: 20px; color: #333; }
        .shrinkage-table { width: 100%; border-collapse: collapse; }
        .shrinkage-table thead { background: #ff6b6b; color: white; }
        .shrinkage-table th, .shrinkage-table td { padding: 10px; text-align: left; border: 1px solid #ddd; }
        .shrinkage-summary { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .shrinkage-summary h3 { margin-bottom: 10px; color: #856404; }
        .radio-group { display: flex; gap: 20px; margin: 15px 0; }
        .radio-group label { display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; }
        .radio-group input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }
        .excel-library-item { background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea; }
        .excel-library-item button { padding: 8px 12px; font-size: 12px; cursor: pointer; border: none; border-radius: 4px; background: #2196f3; color: white; }
        @media (max-width: 768px) {
            .nav-tabs { justify-content: flex-start; }
            .nav-tabs button { padding: 12px 15px; font-size: 12px; }
            .header h1 { font-size: 1.8em; }
            .header-buttons { flex-direction: column; }
            table { font-size: 0.9em; }
            th, td { padding: 8px 10px; }
            .sheet-controls { flex-direction: column; align-items: flex-start; }
            .inventory-controls { flex-direction: column; }
            .analytics-grid { grid-template-columns: 1fr; }
            .radio-group { flex-direction: column; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkDC2tBw5kswXpN5Cbnr39kbLhcLGxK8I",
            authDomain: "knife-inventory-management.firebaseapp.com",
            databaseURL: "https://knife-inventory-management-default-rtdb.firebaseio.com",
            projectId: "knife-inventory-management",
            storageBucket: "knife-inventory-management.firebasestorage.app",
            messagingSenderId: "944440388498",
            appId: "1:944440388498:web:8eadb87306507966f1af4b",
            measurementId: "G-SSQ4E6R5TW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.firebaseDB = db;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseReady = true;

        console.log("‚úÖ Firebase initialized");
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Knife Inventory Manager v30</h1>
            <p>üéâ Advanced Edition - Analytics, Excel Library & Dynamic Products</p>
            <div class="header-buttons">
                <button class="nav-link" onclick="saveAllDataNow()">üíæ Save All Data</button>
                <button class="nav-link export-btn" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="nav-link import-btn" onclick="openImportExcelModal()">üì• Import from Excel</button>
                <button class="nav-link" onclick="openAddProductModal()" style="background: #9c27b0; color: white; border-color: #9c27b0;">‚ûï Add Product</button>
                <button class="nav-link reset-btn" onclick="resetAllData()">üßπ Reset All Data</button>
            </div>
        </div>

        <div id="successBanner" class="success-banner"></div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="openTab(event, 'master-inv')">Master Inventory</button>
            <button class="tab-btn" onclick="openTab(event, 'aaron-nav')">Aaron Navigation</button>
            <button class="tab-btn" onclick="openTab(event, 'pop-nav')">Pop Navigation</button>
            <button class="tab-btn" onclick="openTab(event, 'aaron-inv')">Aaron Inventory</button>
            <button class="tab-btn" onclick="openTab(event, 'pop-inv')">Pop Inventory</button>
            <button class="tab-btn" onclick="openTab(event, 'shrinkage')">üì¶ Shrinkage Tracking</button>
            <button class="tab-btn" onclick="openTab(event, 'analytics')">üìä Sales Analytics</button>
            <button class="tab-btn" onclick="openTab(event, 'excel-library')">üìÅ Excel Library</button>
        </div>

        <!-- Master Inventory -->
        <div id="master-inv" class="tab-content active">
            <div class="tab-section">
                <h2>Master Inventory - Combined Stock</h2>
                <p>Shows current stock levels for all knife products across both Pop and Aaron inventories.</p>
                <table>
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Pop Total</th>
                            <th>Aaron Total</th>
                            <th>Combined Total</th>
                        </tr>
                    </thead>
                    <tbody id="master-inv-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Aaron Navigation -->
        <div id="aaron-nav" class="tab-content">
            <div class="tab-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px;">
                    <h2 style="margin: 0;">Aaron's Inventory Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="nav-link" onclick="openNewAaronSalesSheetModal()" style="margin: 0;">‚ûï New Sales Sheet</button>
                        <button class="nav-link" onclick="openDeleteAaronSalesSheetModal()" style="margin: 0; background: #ff6b6b; color: white; border-color: #ff6b6b;">üóëÔ∏è Delete</button>
                    </div>
                </div>
                <div class="nav-links">
                    <button class="nav-link" onclick="openTab(event, 'aaron-inv')">Aaron Inventory</button>
                    <div id="dynamic-aaron-sales-links" style="display: inline;"></div>
                </div>
            </div>
        </div>

        <!-- Pop Navigation -->
        <div id="pop-nav" class="tab-content">
            <div class="tab-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px;">
                    <h2 style="margin: 0;">Pop's Inventory Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="nav-link" onclick="openNewSalesSheetModal()" style="margin: 0;">‚ûï New Sales Sheet</button>
                        <button class="nav-link" onclick="openDeletePopSalesSheetModal()" style="margin: 0; background: #ff6b6b; color: white; border-color: #ff6b6b;">üóëÔ∏è Delete</button>
                    </div>
                </div>
                <div class="nav-links">
                    <button class="nav-link" onclick="openTab(event, 'pop-inv')">Pop Inventory</button>
                    <button class="nav-link" onclick="openTab(event, 'wetumpka')">Wetumpka</button>
                    <button class="nav-link" onclick="openTab(event, 'trussville')">Trussville</button>
                    <button class="nav-link" onclick="openTab(event, 'columbia')">Columbia</button>
                    <button class="nav-link" onclick="openTab(event, 'hattiesburg')">Hattiesburg</button>
                    <div id="dynamic-sales-links" style="display: inline;"></div>
                </div>
            </div>
        </div>

        <!-- Aaron Inventory -->
        <div id="aaron-inv" class="tab-content">
            <div class="tab-section">
                <h2>Aaron's Current Inventory</h2>
                <div class="flow-info">
                    <strong>‚úÖ SET PRICES FIRST!</strong> Enter selling prices for each product, then activate a sales sheet.
                </div>
                <div class="depletion-notice">
                    ‚úÖ Auto-Depletion: When you lock a sheet, Show Tub depletes by units sold!
                </div>
                <div class="aggregation-info">
                    üìä Units Sold = Running total from all LOCKED sales sheets
                </div>
                <div class="inventory-controls">
                    <h3>Inventory Management</h3>
                    <button class="nav-link" onclick="openAaronInventoryReceivedModal()" style="margin: 0;">‚ûï Add Inventory Received</button>
                    <button class="nav-link" onclick="openAaronMoveInventoryModal()" style="margin: 0; background: #ff9800; color: white; border-color: #ff9800;">‚ÜîÔ∏è Move to Show Tub</button>
                    <button class="nav-link" onclick="openAaronMoveBackInventoryModal()" style="margin: 0; background: #9c27b0; color: white; border-color: #9c27b0;">‚ÜîÔ∏è Move Back to Storage</button>
                    <button class="remove-btn" onclick="openAaronRemoveInventoryModal()">üóëÔ∏è Remove from Storage</button>
                </div>
                <table>
                    <thead><tr><th>Product Name</th><th>Selling Price</th><th>Storage Tub</th><th>Show Tub</th><th>Units Sold (Locked)</th><th>Total On Hand</th></tr></thead>
                    <tbody id="aaron-inv-tbody">
                    </tbody>
                </table>
                <table>
                    <thead><tr><th colspan="3">Totals</th><th>Storage Total</th><th>Show Tub Total</th><th>Combined Total</th></tr></thead>
                    <tbody>
                        <tr class="summary-row">
                            <td colspan="3"><strong>AARON TOTALS</strong></td>
                            <td><input type="number" id="aaron-storage-total" readonly></td>
                            <td><input type="number" id="aaron-show-total" readonly></td>
                            <td><input type="number" id="aaron-combined-total" readonly style="font-weight: bold;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pop Inventory -->
        <div id="pop-inv" class="tab-content">
            <div class="tab-section">
                <h2>Pop's Current Inventory</h2>
                <div class="flow-info">
                    <strong>‚úÖ SET PRICES FIRST!</strong> Enter selling prices for each product, then activate a sales sheet.
                </div>
                <div class="depletion-notice">
                    ‚úÖ Auto-Depletion: When you lock a sheet, Show Tub depletes by units sold!
                </div>
                <div class="aggregation-info">
                    üìä Units Sold = Running total from all LOCKED sales sheets
                </div>
                <div class="inventory-controls">
                    <h3>Inventory Management</h3>
                    <button class="nav-link" onclick="openPopInventoryReceivedModal()" style="margin: 0;">‚ûï Add Inventory Received</button>
                    <button class="nav-link" onclick="openPopMoveInventoryModal()" style="margin: 0; background: #ff9800; color: white; border-color: #ff9800;">‚ÜîÔ∏è Move to Show Tub</button>
                    <button class="nav-link" onclick="openPopMoveBackInventoryModal()" style="margin: 0; background: #9c27b0; color: white; border-color: #9c27b0;">‚ÜîÔ∏è Move Back to Storage</button>
                    <button class="remove-btn" onclick="openPopRemoveInventoryModal()">üóëÔ∏è Remove from Storage</button>
                </div>
                <table>
                    <thead><tr><th>Product Name</th><th>Selling Price</th><th>Storage Tub</th><th>Show Tub</th><th>Units Sold (Locked)</th><th>Total On Hand</th></tr></thead>
                    <tbody id="pop-inv-tbody">
                    </tbody>
                </table>
                <table>
                    <thead><tr><th colspan="3">Totals</th><th>Storage Total</th><th>Show Tub Total</th><th>Combined Total</th></tr></thead>
                    <tbody>
                        <tr class="summary-row">
                            <td colspan="3"><strong>POP TOTALS</strong></td>
                            <td><input type="number" id="pop-storage-total" readonly></td>
                            <td><input type="number" id="pop-show-total" readonly></td>
                            <td><input type="number" id="pop-combined-total" readonly style="font-weight: bold;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Sheets Container -->
        <div id="sales-sheets-container"></div>

        <!-- Shrinkage Tracking Tab -->
        <div id="shrinkage" class="tab-content">
            <div class="tab-section">
                <h2>üì¶ Shrinkage Tracking - Broken Items</h2>
                <p>Track broken or damaged items to maintain accurate inventory.</p>
                <div class="inventory-controls">
                    <h3>Log Shrinkage</h3>
                    <button class="nav-link" onclick="openAddShrinkageModal()" style="margin: 0;">‚ûï Add Broken Item</button>
                </div>
                <div id="shrinkage-summary" class="shrinkage-summary" style="display: none;">
                    <h3>üìä Shrinkage Summary</h3>
                    <table style="width: 100%;">
                        <thead>
                            <tr><th>Product</th><th>Pop Broken</th><th>Aaron Broken</th><th>Total Broken</th></tr>
                        </thead>
                        <tbody id="shrinkage-summary-tbody">
                        </tbody>
                    </table>
                </div>
                <table class="shrinkage-table">
                    <thead>
                        <tr><th>Date</th><th>Person</th><th>Product</th><th>Qty</th><th>From</th><th>Notes</th><th>Action</th></tr>
                    </thead>
                    <tbody id="shrinkage-log">
                        <tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No shrinkage recorded yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="tab-section">
                <h2>üìä Sales Analytics Dashboard</h2>
                <p>Track your top sellers and sales trends over time.</p>
                
                <h3 style="margin-top: 30px; color: #333;">Pop's Analytics</h3>
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>ü•á Top Sellers by Units</h3>
                        <canvas id="popTopSellersChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üí∞ Top Sellers by Revenue</h3>
                        <canvas id="popRevenueChart"></canvas>
                    </div>
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <h3>üìà Sales Trend Over Time</h3>
                        <canvas id="popTrendChart"></canvas>
                    </div>
                </div>

                <h3 style="margin-top: 30px; color: #333;">Aaron's Analytics</h3>
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>ü•á Top Sellers by Units</h3>
                        <canvas id="aaronTopSellersChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üí∞ Top Sellers by Revenue</h3>
                        <canvas id="aaronRevenueChart"></canvas>
                    </div>
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <h3>üìà Sales Trend Over Time</h3>
                        <canvas id="aaronTrendChart"></canvas>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="refresh-btn" onclick="refreshAnalytics()">Refresh Analytics</button>
                </div>
            </div>
        </div>

        <!-- Excel Library Tab -->
        <div id="excel-library" class="tab-content">
            <div class="tab-section">
                <h2>üìÅ Excel Export Library</h2>
                <p>All exported Excel files are saved here for quick download.</p>
                <div id="excel-library-items" style="margin-top: 20px;">
                    <p style="color: #999; text-align: center;">No exports yet. Export your data to see it here.</p>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="activateSheetModal" class="modal"><div class="modal-content"><h3>üìã Activate Sales Sheet</h3><div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-weight: 600;">Sheet: <span id="activateSheetName"></span></p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeActivateSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmActivateSheet()" style="background: #2196f3;">‚úì Activate</button></div></div></div>

        <div id="lockSheetModal" class="modal"><div class="modal-content"><h3>üîí Lock Sheet?</h3><div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-size: 13px; color: #856404;">‚ö†Ô∏è Locking will deplete Show Tub by units sold and add to inventory total.</p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeLockSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmLockSheet()" style="background: #ff9800;">üîí Lock</button></div></div></div>

        <div id="unlockSheetModal" class="modal"><div class="modal-content"><h3>üîì Unlock Sheet?</h3><div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-size: 13px; color: #856404;">‚ö†Ô∏è Unlocking removes units sold from inventory total.</p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeUnlockSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmUnlockSheet()" style="background: #4caf50;">üîì Unlock</button></div></div></div>

        <div id="resetSheetModal" class="modal"><div class="modal-content"><h3>‚ö†Ô∏è Reset Sheet to 0?</h3><div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-size: 13px; color: #856404;">This will clear all data in this sheet. This action cannot be undone.</p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeResetSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmResetSheet()" style="background: #ff6b6b;">Reset</button></div></div></div>

        <div id="eventCompletedConfirmModal" class="modal"><div class="modal-content"><h3>‚úÖ Event Completed?</h3><div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-weight: 600;"><span id="confirmEventSheetName"></span></p><p style="margin: 10px 0 0 0;">Units: <strong id="confirmEventUnits">--</strong> | Revenue: <strong id="confirmEventRevenue">--</strong></p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeEventCompletedConfirmModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmEventCompleted()" style="background: #4caf50;">‚úÖ Complete</button></div></div></div>

        <div id="addShrinkageModal" class="modal"><div class="modal-content"><h3>Add Shrinkage Entry</h3><div class="form-group"><label>Person:</label><select id="shrinkage-person"><option value="pop">Pop</option><option value="aaron">Aaron</option></select></div><div class="form-group"><label>Product:</label><select id="shrinkage-product"></select></div><div class="form-group"><label>Quantity:</label><input type="number" id="shrinkage-qty" value="1" min="1"></div><div class="form-group"><label>Deplete From:</label><div class="radio-group"><label><input type="radio" name="shrinkage-from" value="storage" checked> Storage Tub</label><label><input type="radio" name="shrinkage-from" value="show"> Show Tub</label><label><input type="radio" name="shrinkage-from" value="both"> Both (equal split)</label></div></div><div class="form-group"><label>Notes:</label><input type="text" id="shrinkage-notes" placeholder="e.g., Broken handle"></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeShrinkageModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addShrinkageEntry()">Add</button></div></div></div>

        <div id="addProductModal" class="modal"><div class="modal-content"><h3>Add New Product</h3><div class="form-group"><label>Product Name:</label><input type="text" id="new-product-name" placeholder="e.g., Tactical Blade"></div><div class="form-group"><label>Default Price (Pop):</label><input type="number" id="new-product-price-pop" placeholder="0" min="0"></div><div class="form-group"><label>Default Price (Aaron):</label><input type="number" id="new-product-price-aaron" placeholder="0" min="0"></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAddProductModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmAddProduct()">Add Product</button></div></div></div>

        <div id="popInventoryReceivedModal" class="modal"><div class="modal-content"><h3>Add Inventory - Pop</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty</th></tr></thead><tbody id="pop-received-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closePopInventoryReceivedModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addPopInventoryReceived()">Add</button></div></div></div>

        <div id="aaronInventoryReceivedModal" class="modal"><div class="modal-content"><h3>Add Inventory - Aaron</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty</th></tr></thead><tbody id="aaron-received-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAaronInventoryReceivedModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addAaronInventoryReceived()">Add</button></div></div></div>

        <div id="popMoveInventoryModal" class="modal"><div class="modal-content"><h3>Move to Show Tub - Pop</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty to Move</th></tr></thead><tbody id="pop-move-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closePopMoveInventoryModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addPopMoveInventory()">Move</button></div></div></div>

        <div id="aaronMoveInventoryModal" class="modal"><div class="modal-content"><h3>Move to Show Tub - Aaron</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty to Move</th></tr></thead><tbody id="aaron-move-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAaronMoveInventoryModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addAaronMoveInventory()">Move</button></div></div></div>

        <div id="popMoveBackInventoryModal" class="modal"><div class="modal-content"><h3>Move Back to Storage - Pop</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty to Move</th></tr></thead><tbody id="pop-move-back-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closePopMoveBackInventoryModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addPopMoveBackInventory()">Move</button></div></div></div>

        <div id="aaronMoveBackInventoryModal" class="modal"><div class="modal-content"><h3>Move Back to Storage - Aaron</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty to Move</th></tr></thead><tbody id="aaron-move-back-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAaronMoveBackInventoryModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addAaronMoveBackInventory()">Move</button></div></div></div>

        <div id="popRemoveInventoryModal" class="modal"><div class="modal-content"><h3>Remove from Storage - Pop</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty to Remove</th></tr></thead><tbody id="pop-remove-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closePopRemoveInventoryModal()">Cancel</button><button type="button" class="btn-remove" onclick="addPopRemoveInventory()">Remove</button></div></div></div>

        <div id="aaronRemoveInventoryModal" class="modal"><div class="modal-content"><h3>Remove from Storage - Aaron</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty to Remove</th></tr></thead><tbody id="aaron-remove-tbody"></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAaronRemoveInventoryModal()">Cancel</button><button type="button" class="btn-remove" onclick="addAaronRemoveInventory()">Remove</button></div></div></div>

        <div id="importExcelModal" class="modal"><div class="modal-content"><h3>Import from Excel</h3><p style="margin: 0 0 20px 0; color: #666; font-size: 13px;">Select an Excel file exported from this system to import all data.</p><div class="form-group"><input type="file" id="import-file" accept=".xlsx,.xls"></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeImportExcelModal()">Cancel</button><button type="button" class="btn-import" onclick="confirmImportExcel()">Import</button></div></div></div>

        <div id="newSalesSheetModal" class="modal"><div class="modal-content"><h3>Create New Sales Sheet - Pop</h3><div class="form-group"><label>Sheet Name (e.g., Nashville - Dec 1-2):</label><input type="text" id="new-sheet-name"></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeNewSalesSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmNewSalesSheet()">Create</button></div></div></div>

        <div id="newAaronSalesSheetModal" class="modal"><div class="modal-content"><h3>Create New Sales Sheet - Aaron</h3><div class="form-group"><label>Sheet Name (e.g., Nashville - Dec 1-2):</label><input type="text" id="new-aaron-sheet-name"></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeNewAaronSalesSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmNewAaronSalesSheet()">Create</button></div></div></div>

        <div id="deleteSalesSheetModal" class="modal"><div class="modal-content"><h3>Delete Sales Sheet</h3><p style="margin-bottom: 20px;">Select sheet to delete:</p><select id="delete-sheet-select" style="width: 100%; padding: 10px; margin-bottom: 20px;"></select><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeDeleteSalesSheetModal()">Cancel</button><button type="button" class="btn-remove" onclick="confirmDeleteSalesSheet()">Delete</button></div></div></div>
    </div>

    <script>
        // GLOBAL STATE
        let productNames = ["Full Tang", "8\" Rat", "6\" Rat", "8\" Stag", "6\" Stag", "Grooved", "Folders", "Bull Cutters", "Horizontal Sheaths", "Bowies", "Mini Folders"];
        let NUM_PRODUCTS = productNames.length;
        let staticSheets = ["wetumpka", "trussville", "columbia", "hattiesburg"];
        let sheetMetadata = {
            "wetumpka": { name: "Wetumpka, Alabama", person: "pop", date: "2024-12-12" },
            "trussville": { name: "Trussville, Alabama", person: "pop", date: "2024-01-03" },
            "columbia": { name: "Columbia, Tennessee", person: "pop", date: "2024-01-10" },
            "hattiesburg": { name: "Hattiesburg, Mississippi", person: "pop", date: "2024-01-17" }
        };
        let sheetStates = {};
        let shrinkageLog = [];
        let excelLibrary = [];
        let pendingActivateSheet = null;
        let pendingLockSheet = null;
        let pendingUnlockSheet = null;
        let pendingResetSheet = null;
        let pendingEventCompletedSheet = null;
        let pendingDeleteSheet = null;
        let chartsInstances = {};

        // INITIALIZATION
        function initializeApp() {
            initSheetStates();
            renderMasterInventoryTable();
            renderInventoryTables();
            renderSalesSheets();
            renderShrinkageModal();
            renderAddProductModal();
            renderReceiveModals();
            renderMoveInventoryModals();
            renderRemoveInventoryModals();
            loadDataFromFirebase();
        }

        function initSheetStates() {
            staticSheets.forEach(sheet => {
                sheetStates[sheet] = { active: false, locked: false, completed: false };
            });
        }

        function renderMasterInventoryTable() {
            const tbody = document.getElementById('master-inv-tbody');
            tbody.innerHTML = '';
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${productNames[i]}</td>
                    <td><input type="number" class="master-pop-stock" data-product="${i}" readonly></td>
                    <td><input type="number" class="master-aaron-stock" data-product="${i}" readonly></td>
                    <td><input type="number" class="master-combined" data-product="${i}" readonly style="font-weight: bold;"></td>
                `;
                tbody.appendChild(row);
            }
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td><strong>GRAND TOTAL</strong></td>
                <td><input type="number" id="master-pop-total" readonly style="font-weight: bold;"></td>
                <td><input type="number" id="master-aaron-total" readonly style="font-weight: bold;"></td>
                <td><input type="number" id="master-grand-total" readonly style="font-weight: bold; background: #667eea; color: white;"></td>
            `;
            tbody.appendChild(totalRow);
        }

        function renderInventoryTables() {
            renderPersonInventoryTable('pop');
            renderPersonInventoryTable('aaron');
        }

        function renderPersonInventoryTable(person) {
            const tbody = document.getElementById(`${person}-inv-tbody`);
            tbody.innerHTML = '';
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${productNames[i]}</td>
                    <td><input type="number" placeholder="0" class="${person}-price" data-product="${i}" onchange="recalculateAllRevenue()"></td>
                    <td><input type="number" placeholder="Storage" class="${person}-storage" data-product="${i}" readonly></td>
                    <td><input type="number" placeholder="Show" class="${person}-show-tub" data-product="${i}"></td>
                    <td><input type="number" class="${person}-units-sold-agg" data-product="${i}" readonly></td>
                    <td><input type="number" class="${person}-current-stock" data-product="${i}" readonly value="0"></td>
                `;
                tbody.appendChild(row);
            }
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `<td colspan="5">Total knives on hand</td><td><input type="number" id="${person}-total-on-hand" readonly value="0"></td>`;
            tbody.appendChild(totalRow);
        }

        function renderSalesSheets() {
            const container = document.getElementById('sales-sheets-container');
            container.innerHTML = '';
            const allSheets = [...staticSheets, ...Object.keys(sheetMetadata).filter(k => !staticSheets.includes(k))];
            allSheets.forEach(sheetId => {
                if (!sheetMetadata[sheetId]) return;
                const div = document.createElement('div');
                div.id = sheetId;
                div.className = 'tab-content';
                div.innerHTML = generateSheetHTML(sheetId);
                container.appendChild(div);
            });
        }

        function generateSheetHTML(sheetId) {
            const meta = sheetMetadata[sheetId];
            if (!meta) return '';
            let tableRows = '';
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                tableRows += `<tr><td>${productNames[i]}</td><td><input type="number" class="units-brought" data-sheet="${sheetId}" data-row="${i}" readonly></td><td><span class="units-sold" data-sheet="${sheetId}" data-row="${i}">0</span></td><td><input type="number" class="units-left" data-sheet="${sheetId}" data-row="${i}"></td></tr>`;
            }
            return `
                <div class="tab-section">
                    <h2>${meta.name}</h2>
                    <button class="refresh-btn" onclick="refreshSheetData('${meta.person}', '${sheetId}')">Refresh Units Brought</button>
                    <div class="sheet-controls">
                        <div class="sheet-status inactive" id="${sheetId}-status">‚óè Inactive</div>
                        <button class="sheet-btn" onclick="openActivateSheetModal('${meta.person}', '${sheetId}')">üìã Activate Sheet</button>
                        <button class="sheet-btn lock-btn" id="lock-btn-${sheetId}" style="display:none;" onclick="openLockSheetModal('${sheetId}')">üîí Lock Sheet</button>
                        <button class="sheet-btn unlock-btn" id="unlock-btn-${sheetId}" style="display:none;" onclick="openUnlockSheetModal('${sheetId}')">üîì Unlock Sheet</button>
                        <button class="sheet-btn" id="reset-btn-${sheetId}" style="display:none; background: #ff6b6b;" onclick="openResetSheetModal('${sheetId}')">‚ü≤ Reset Sheet</button>
                    </div>
                    <div class="event-checkbox" id="${sheetId}-event-box" style="display: none;">
                        <input type="checkbox" id="event-completed-${sheetId}" onchange="toggleEventCompleted('${sheetId}')">
                        <label for="event-completed-${sheetId}">‚úÖ Event Completed (Locks Data)</label>
                    </div>
                    <table>
                        <thead><tr><th>Product Name</th><th>Units Brought</th><th>Units Sold</th><th>Units Left in Tub</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    <table>
                        <tbody>
                            <tr class="units-sold-row"><td><strong>TOTAL UNITS SOLD</strong></td><td colspan="3"><input type="number" class="total-units-sold" data-sheet="${sheetId}" id="total-units-${sheetId}" readonly></td></tr>
                            <tr class="revenue-row"><td colspan="1"><strong>TOTAL REVENUE</strong></td><td colspan="3"><input type="number" class="revenue-total" data-sheet="${sheetId}" id="total-revenue-${sheetId}" readonly></td></tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderShrinkageModal() {
            const select = document.getElementById('shrinkage-product');
            select.innerHTML = '';
            productNames.forEach((name, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        function renderAddProductModal() {
            // Modal already exists in HTML, just need to set up form
        }

        function renderReceiveModals() {
            ['pop', 'aaron'].forEach(person => {
                const tbody = document.getElementById(`${person}-received-tbody`);
                tbody.innerHTML = '';
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${productNames[i]}</td><td><input type="number" id="${person}-received-${i}"></td>`;
                    tbody.appendChild(row);
                }
            });
        }

        function renderMoveInventoryModals() {
            ['pop', 'aaron'].forEach(person => {
                const tbody = document.getElementById(`${person}-move-tbody`);
                tbody.innerHTML = '';
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${productNames[i]}</td><td><input type="number" id="${person}-move-${i}"></td>`;
                    tbody.appendChild(row);
                }
                const moveBackTbody = document.getElementById(`${person}-move-back-tbody`);
                moveBackTbody.innerHTML = '';
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${productNames[i]}</td><td><input type="number" id="${person}-move-back-${i}"></td>`;
                    moveBackTbody.appendChild(row);
                }
            });
        }

        function renderRemoveInventoryModals() {
            ['pop', 'aaron'].forEach(person => {
                const tbody = document.getElementById(`${person}-remove-tbody`);
                tbody.innerHTML = '';
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${productNames[i]}</td><td><input type="number" id="${person}-remove-${i}"></td>`;
                    tbody.appendChild(row);
                }
            });
        }

        function updateDeleteSheetSelect() {
            const select = document.getElementById('delete-sheet-select');
            select.innerHTML = '';
            const allSheets = [...Object.keys(sheetMetadata)];
            allSheets.forEach(sheetId => {
                if (!sheetMetadata[sheetId]) return;
                const option = document.createElement('option');
                option.value = sheetId;
                option.textContent = sheetMetadata[sheetId].name;
                select.appendChild(option);
            });
        }

        // TAB FUNCTIONS
        function openTab(evt, tabName) {
            const tabcontent = document.querySelectorAll('.tab-content');
            tabcontent.forEach(tab => tab.classList.remove('active'));
            const tabbuttons = document.querySelectorAll('.tab-btn');
            tabbuttons.forEach(btn => btn.classList.remove('active'));
            const tabEl = document.getElementById(tabName);
            if (tabEl) tabEl.classList.add('active');
            if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
            if (tabName === 'analytics') {
                setTimeout(() => refreshAnalytics(), 100);
            }
            if (tabName === 'excel-library') {
                renderExcelLibrary();
            }
        }

        function showSuccess(message) {
            const banner = document.getElementById('successBanner');
            banner.textContent = message;
            banner.classList.add('show');
            setTimeout(() => banner.classList.remove('show'), 3000);
        }

        // INVENTORY CALCULATIONS
        function updateAllInventories() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                ['pop', 'aaron'].forEach(person => {
                    const storage = parseFloat(document.querySelector(`.${person}-storage[data-product="${i}"]`)?.value || 0);
                    const showTub = parseFloat(document.querySelector(`.${person}-show-tub[data-product="${i}"]`)?.value || 0);
                    const stock = document.querySelector(`.${person}-current-stock[data-product="${i}"]`);
                    if (stock) stock.value = storage + showTub;
                    const masterEl = document.querySelector(`.master-${person}-stock[data-product="${i}"]`);
                    if (masterEl) masterEl.value = storage + showTub;
                });
                const popStock = parseFloat(document.querySelector(`.pop-current-stock[data-product="${i}"]`)?.value || 0);
                const aaronStock = parseFloat(document.querySelector(`.aaron-current-stock[data-product="${i}"]`)?.value || 0);
                const masterCombined = document.querySelector(`.master-combined[data-product="${i}"]`);
                if (masterCombined) masterCombined.value = popStock + aaronStock;
            }

            // Update totals
            let popStorageTotal = 0, popShowTotal = 0, popCombined = 0;
            let aaronStorageTotal = 0, aaronShowTotal = 0, aaronCombined = 0;
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const popStorage = parseFloat(document.querySelector(`.pop-storage[data-product="${i}"]`)?.value || 0);
                const popShow = parseFloat(document.querySelector(`.pop-show-tub[data-product="${i}"]`)?.value || 0);
                const aaronStorage = parseFloat(document.querySelector(`.aaron-storage[data-product="${i}"]`)?.value || 0);
                const aaronShow = parseFloat(document.querySelector(`.aaron-show-tub[data-product="${i}"]`)?.value || 0);
                popStorageTotal += popStorage;
                popShowTotal += popShow;
                popCombined += popStorage + popShow;
                aaronStorageTotal += aaronStorage;
                aaronShowTotal += aaronShow;
                aaronCombined += aaronStorage + aaronShow;
            }
            document.getElementById('pop-storage-total').value = popStorageTotal;
            document.getElementById('pop-show-total').value = popShowTotal;
            document.getElementById('pop-combined-total').value = popCombined;
            document.getElementById('aaron-storage-total').value = aaronStorageTotal;
            document.getElementById('aaron-show-total').value = aaronShowTotal;
            document.getElementById('aaron-combined-total').value = aaronCombined;

            // Master totals
            document.getElementById('master-pop-total').value = popCombined;
            document.getElementById('master-aaron-total').value = aaronCombined;
            document.getElementById('master-grand-total').value = popCombined + aaronCombined;
            document.getElementById('pop-total-on-hand').value = popCombined;
            document.getElementById('aaron-total-on-hand').value = aaronCombined;

            updateInventoryAggregatedUnitsSold();
        }

        function updateInventoryAggregatedUnitsSold() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                ['pop', 'aaron'].forEach(person => {
                    let total = 0;
                    const allSheetIds = [...staticSheets, ...Object.keys(sheetMetadata).filter(k => !staticSheets.includes(k))];
                    allSheetIds.forEach(sheetId => {
                        const meta = sheetMetadata[sheetId];
                        if (meta?.person !== person || !sheetStates[sheetId]?.locked) return;
                        const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                        if (soldEl) total += parseFloat(soldEl.textContent || 0);
                    });
                    const agEl = document.querySelector(`.${person}-units-sold-agg[data-product="${i}"]`);
                    if (agEl) agEl.value = total;
                });
            }
        }

        function recalculateAllRevenue() {
            const allSheetIds = [...staticSheets, ...Object.keys(sheetMetadata).filter(k => !staticSheets.includes(k))];
            allSheetIds.forEach(sheetId => {
                recalculateRevenueForSheet(sheetId);
            });
            saveAllDataNow();
        }

        function recalculateRevenueForSheet(sheetId) {
            const meta = sheetMetadata[sheetId];
            if (!meta) return;
            const person = meta.person;
            let totalUnits = 0, totalRevenue = 0;
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                const priceEl = document.querySelector(`.${person}-price[data-product="${i}"]`);
                const unitsSold = parseFloat(soldEl?.textContent || 0);
                const price = parseFloat(priceEl?.value || 0);
                totalUnits += unitsSold;
                totalRevenue += unitsSold * price;
            }
            const totalUnitsEl = document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`);
            const totalRevEl = document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`);
            if (totalUnitsEl) totalUnitsEl.value = totalUnits;
            if (totalRevEl) totalRevEl.value = totalRevenue.toFixed(2);
        }

        // SHEET ACTIVATION & LOCKING
        function openActivateSheetModal(person, sheetId) {
            pendingActivateSheet = { person, sheetId };
            document.getElementById('activateSheetName').textContent = sheetMetadata[sheetId]?.name || sheetId;
            document.getElementById('activateSheetModal').classList.add('active');
        }

        function closeActivateSheetModal() {
            document.getElementById('activateSheetModal').classList.remove('active');
            pendingActivateSheet = null;
        }

        function confirmActivateSheet() {
            const { person, sheetId } = pendingActivateSheet;
            sheetStates[sheetId].active = true;
            updateSheetStatus(sheetId);
            document.getElementById(`${sheetId}-event-box`).style.display = 'flex';
            document.querySelector(`button[onclick="openActivateSheetModal('${person}', '${sheetId}')"]`).style.display = 'none';
            initializeUnitsLeftListeners(sheetId);
            saveAllDataNow();
            showSuccess('‚úÖ Sheet activated!');
            closeActivateSheetModal();
        }

        function openLockSheetModal(sheetId) {
            pendingLockSheet = sheetId;
            document.getElementById('lockSheetModal').classList.add('active');
        }

        function closeLockSheetModal() {
            document.getElementById('lockSheetModal').classList.remove('active');
            pendingLockSheet = null;
        }

        function confirmLockSheet() {
            const sheetId = pendingLockSheet;
            const meta = sheetMetadata[sheetId];
            sheetStates[sheetId].locked = true;
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                const showTubEl = document.querySelector(`.${meta.person}-show-tub[data-product="${i}"]`);
                const unitsSold = parseFloat(soldEl?.textContent || 0);
                if (showTubEl) {
                    showTubEl.value = Math.max(0, parseFloat(showTubEl.value || 0) - unitsSold);
                }
            }
            document.querySelectorAll(`.units-left[data-sheet="${sheetId}"]`).forEach(el => el.disabled = true);
            updateSheetStatus(sheetId);
            document.getElementById(`lock-btn-${sheetId}`).style.display = 'none';
            document.getElementById(`unlock-btn-${sheetId}`).style.display = 'inline-flex';
            document.getElementById(`reset-btn-${sheetId}`).style.display = 'inline-flex';
            updateAllInventories();
            updateInventoryAggregatedUnitsSold();
            recalculateRevenueForSheet(sheetId);
            saveAllDataNow();
            showSuccess('‚úÖ Sheet locked!');
            closeLockSheetModal();
        }

        function openUnlockSheetModal(sheetId) {
            pendingUnlockSheet = sheetId;
            document.getElementById('unlockSheetModal').classList.add('active');
        }

        function closeUnlockSheetModal() {
            document.getElementById('unlockSheetModal').classList.remove('active');
            pendingUnlockSheet = null;
        }

        function confirmUnlockSheet() {
            const sheetId = pendingUnlockSheet;
            const meta = sheetMetadata[sheetId];
            sheetStates[sheetId].locked = false;
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                const showTubEl = document.querySelector(`.${meta.person}-show-tub[data-product="${i}"]`);
                const unitsSold = parseFloat(soldEl?.textContent || 0);
                if (showTubEl) {
                    showTubEl.value = parseFloat(showTubEl.value || 0) + unitsSold;
                }
            }
            document.querySelectorAll(`.units-left[data-sheet="${sheetId}"]`).forEach(el => el.disabled = false);
            updateSheetStatus(sheetId);
            document.getElementById(`unlock-btn-${sheetId}`).style.display = 'none';
            document.getElementById(`lock-btn-${sheetId}`).style.display = 'inline-flex';
            document.getElementById(`reset-btn-${sheetId}`).style.display = 'none';
            updateAllInventories();
            updateInventoryAggregatedUnitsSold();
            recalculateRevenueForSheet(sheetId);
            saveAllDataNow();
            showSuccess('‚úÖ Sheet unlocked!');
            closeUnlockSheetModal();
        }

        function openResetSheetModal(sheetId) {
            pendingResetSheet = sheetId;
            document.getElementById('resetSheetModal').classList.add('active');
        }

        function closeResetSheetModal() {
            document.getElementById('resetSheetModal').classList.remove('active');
            pendingResetSheet = null;
        }

        function confirmResetSheet() {
            const sheetId = pendingResetSheet;
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const broughtEl = document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${i}"]`);
                const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                const leftEl = document.querySelector(`.units-left[data-sheet="${sheetId}"][data-row="${i}"]`);
                if (broughtEl) broughtEl.value = 0;
                if (soldEl) soldEl.textContent = '0';
                if (leftEl) leftEl.value = 0;
            }
            document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`).value = 0;
            document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`).value = 0;
            updateAllInventories();
            recalculateRevenueForSheet(sheetId);
            saveAllDataNow();
            showSuccess('‚úÖ Sheet reset!');
            closeResetSheetModal();
        }

        function updateSheetStatus(sheetId) {
            const statusEl = document.getElementById(`${sheetId}-status`);
            if (!statusEl) return;
            if (sheetStates[sheetId]?.locked) {
                statusEl.textContent = 'üîí Locked';
                statusEl.className = 'sheet-status completed';
            } else if (sheetStates[sheetId]?.active) {
                statusEl.textContent = '‚óè Active';
                statusEl.className = 'sheet-status active';
            } else {
                statusEl.textContent = '‚óè Inactive';
                statusEl.className = 'sheet-status inactive';
            }
        }

        function initializeUnitsLeftListeners(sheetId) {
            document.querySelectorAll(`.units-left[data-sheet="${sheetId}"]`).forEach(input => {
                input.removeEventListener('change', handleUnitsLeftChange);
                input.addEventListener('change', handleUnitsLeftChange);
            });
        }

        function handleUnitsLeftChange(e) {
            const sheetId = e.target.getAttribute('data-sheet');
            const rowIndex = parseInt(e.target.getAttribute('data-row'));
            const meta = sheetMetadata[sheetId];
            const unitsLeft = parseFloat(e.target.value || 0);
            const unitsBroughtEl = document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${rowIndex}"]`);
            if (!unitsBroughtEl) return;
            const unitsBrought = parseFloat(unitsBroughtEl.value || 0);
            const newUnitsSold = Math.max(0, unitsBrought - unitsLeft);
            const unitsSoldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${rowIndex}"]`);
            if (!unitsSoldEl) return;
            const oldUnitsSold = parseFloat(unitsSoldEl.textContent || 0);
            unitsSoldEl.textContent = newUnitsSold;
            recalculateRevenueForSheet(sheetId);
            updateAllInventories();
            saveAllDataNow();
        }

        // SHRINKAGE
        function openAddShrinkageModal() {
            document.getElementById('addShrinkageModal').classList.add('active');
        }

        function closeShrinkageModal() {
            document.getElementById('addShrinkageModal').classList.remove('active');
            document.getElementById('shrinkage-qty').value = '1';
            document.getElementById('shrinkage-notes').value = '';
            document.querySelector('input[name="shrinkage-from"][value="storage"]').checked = true;
        }

        function addShrinkageEntry() {
            const person = document.getElementById('shrinkage-person').value;
            const productIdx = parseInt(document.getElementById('shrinkage-product').value);
            const qty = parseInt(document.getElementById('shrinkage-qty').value);
            const depletFrom = document.querySelector('input[name="shrinkage-from"]:checked').value;
            const notes = document.getElementById('shrinkage-notes').value;

            if (qty <= 0) return alert('Qty must be > 0');

            shrinkageLog.push({ date: new Date().toLocaleDateString(), person, productIdx, qty, depletFrom, notes });

            const storageEl = document.querySelector(`.${person}-storage[data-product="${productIdx}"]`);
            const showEl = document.querySelector(`.${person}-show-tub[data-product="${productIdx}"]`);

            if (depletFrom === 'storage' || depletFrom === 'both') {
                if (storageEl) {
                    const current = parseFloat(storageEl.value || 0);
                    const toRemove = depletFrom === 'both' ? Math.ceil(qty / 2) : qty;
                    storageEl.value = Math.max(0, current - toRemove);
                }
            }
            if (depletFrom === 'show' || depletFrom === 'both') {
                if (showEl) {
                    const current = parseFloat(showEl.value || 0);
                    const toRemove = depletFrom === 'both' ? Math.floor(qty / 2) : qty;
                    showEl.value = Math.max(0, current - toRemove);
                }
            }

            updateAllInventories();
            updateShrinkageDisplay();
            saveAllDataNow();
            showSuccess('‚úÖ Shrinkage logged!');
            closeShrinkageModal();
        }

        function updateShrinkageDisplay() {
            const tbody = document.getElementById('shrinkage-log');
            tbody.innerHTML = '';
            if (shrinkageLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No shrinkage recorded yet.</td></tr>';
                document.getElementById('shrinkage-summary').style.display = 'none';
                return;
            }
            shrinkageLog.forEach((entry, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.person === 'pop' ? 'Pop' : 'Aaron'}</td>
                    <td>${productNames[entry.productIdx]}</td>
                    <td>${entry.qty}</td>
                    <td>${entry.depletFrom === 'storage' ? 'Storage' : entry.depletFrom === 'show' ? 'Show Tub' : 'Both'}</td>
                    <td>${entry.notes}</td>
                    <td><button class="remove-btn" onclick="removeShrinkageEntry(${idx})" style="padding: 4px 8px; font-size: 12px;">Remove</button></td>
                `;
                tbody.appendChild(row);
            });

            // Summary
            const summary = {};
            shrinkageLog.forEach(entry => {
                const key = productNames[entry.productIdx];
                if (!summary[key]) summary[key] = { pop: 0, aaron: 0 };
                summary[key][entry.person] += entry.qty;
            });
            const summaryTbody = document.getElementById('shrinkage-summary-tbody');
            summaryTbody.innerHTML = '';
            Object.entries(summary).forEach(([name, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${name}</td><td>${data.pop}</td><td>${data.aaron}</td><td>${data.pop + data.aaron}</td>`;
                summaryTbody.appendChild(row);
            });
            document.getElementById('shrinkage-summary').style.display = 'block';
        }

        function removeShrinkageEntry(idx) {
            shrinkageLog.splice(idx, 1);
            updateShrinkageDisplay();
            saveAllDataNow();
        }

        // PRODUCTS
        function openAddProductModal() {
            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-price-pop').value = '';
            document.getElementById('new-product-price-aaron').value = '';
            document.getElementById('addProductModal').classList.add('active');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('active');
        }

        function confirmAddProduct() {
            const name = document.getElementById('new-product-name').value.trim();
            const pricePop = parseFloat(document.getElementById('new-product-price-pop').value || 0);
            const priceAaron = parseFloat(document.getElementById('new-product-price-aaron').value || 0);

            if (!name) return alert('Product name is required');

            productNames.push(name);
            NUM_PRODUCTS++;

            renderMasterInventoryTable();
            renderInventoryTables();
            renderSalesSheets();
            renderReceiveModals();
            renderMoveInventoryModals();
            renderRemoveInventoryModals();
            renderShrinkageModal();

            // Set prices
            const popPriceEl = document.querySelector(`.pop-price[data-product="${NUM_PRODUCTS - 1}"]`);
            const aaronPriceEl = document.querySelector(`.aaron-price[data-product="${NUM_PRODUCTS - 1}"]`);
            if (popPriceEl) popPriceEl.value = pricePop;
            if (aaronPriceEl) aaronPriceEl.value = priceAaron;

            updateAllInventories();
            saveAllDataNow();
            showSuccess(`‚úÖ Product "${name}" added!`);
            closeAddProductModal();
        }

        // INVENTORY MODALS
        function openPopInventoryReceivedModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`pop-received-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('popInventoryReceivedModal').classList.add('active');
        }

        function closePopInventoryReceivedModal() {
            document.getElementById('popInventoryReceivedModal').classList.remove('active');
        }

        function addPopInventoryReceived() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const received = parseFloat(document.getElementById(`pop-received-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.pop-storage[data-product="${i}"]`);
                if (storageEl) storageEl.value = parseFloat(storageEl.value) + received;
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory added!');
            closePopInventoryReceivedModal();
        }

        function openAaronInventoryReceivedModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`aaron-received-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('aaronInventoryReceivedModal').classList.add('active');
        }

        function closeAaronInventoryReceivedModal() {
            document.getElementById('aaronInventoryReceivedModal').classList.remove('active');
        }

        function addAaronInventoryReceived() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const received = parseFloat(document.getElementById(`aaron-received-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.aaron-storage[data-product="${i}"]`);
                if (storageEl) storageEl.value = parseFloat(storageEl.value) + received;
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory added!');
            closeAaronInventoryReceivedModal();
        }

        function openPopMoveInventoryModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`pop-move-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('popMoveInventoryModal').classList.add('active');
        }

        function closePopMoveInventoryModal() {
            document.getElementById('popMoveInventoryModal').classList.remove('active');
        }

        function addPopMoveInventory() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const toMove = parseFloat(document.getElementById(`pop-move-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.pop-storage[data-product="${i}"]`);
                const showEl = document.querySelector(`.pop-show-tub[data-product="${i}"]`);
                if (storageEl && showEl && toMove > 0) {
                    const currentStorage = parseFloat(storageEl.value || 0);
                    if (toMove <= currentStorage) {
                        storageEl.value = currentStorage - toMove;
                        showEl.value = parseFloat(showEl.value || 0) + toMove;
                    }
                }
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory moved!');
            closePopMoveInventoryModal();
        }

        function openAaronMoveInventoryModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`aaron-move-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('aaronMoveInventoryModal').classList.add('active');
        }

        function closeAaronMoveInventoryModal() {
            document.getElementById('aaronMoveInventoryModal').classList.remove('active');
        }

        function addAaronMoveInventory() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const toMove = parseFloat(document.getElementById(`aaron-move-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.aaron-storage[data-product="${i}"]`);
                const showEl = document.querySelector(`.aaron-show-tub[data-product="${i}"]`);
                if (storageEl && showEl && toMove > 0) {
                    const currentStorage = parseFloat(storageEl.value || 0);
                    if (toMove <= currentStorage) {
                        storageEl.value = currentStorage - toMove;
                        showEl.value = parseFloat(showEl.value || 0) + toMove;
                    }
                }
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory moved!');
            closeAaronMoveInventoryModal();
        }

        function openPopMoveBackInventoryModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`pop-move-back-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('popMoveBackInventoryModal').classList.add('active');
        }

        function closePopMoveBackInventoryModal() {
            document.getElementById('popMoveBackInventoryModal').classList.remove('active');
        }

        function addPopMoveBackInventory() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const toMove = parseFloat(document.getElementById(`pop-move-back-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.pop-storage[data-product="${i}"]`);
                const showEl = document.querySelector(`.pop-show-tub[data-product="${i}"]`);
                if (storageEl && showEl && toMove > 0) {
                    const currentShow = parseFloat(showEl.value || 0);
                    if (toMove <= currentShow) {
                        showEl.value = currentShow - toMove;
                        storageEl.value = parseFloat(storageEl.value || 0) + toMove;
                    }
                }
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory moved back!');
            closePopMoveBackInventoryModal();
        }

        function openAaronMoveBackInventoryModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`aaron-move-back-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('aaronMoveBackInventoryModal').classList.add('active');
        }

        function closeAaronMoveBackInventoryModal() {
            document.getElementById('aaronMoveBackInventoryModal').classList.remove('active');
        }

        function addAaronMoveBackInventory() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const toMove = parseFloat(document.getElementById(`aaron-move-back-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.aaron-storage[data-product="${i}"]`);
                const showEl = document.querySelector(`.aaron-show-tub[data-product="${i}"]`);
                if (storageEl && showEl && toMove > 0) {
                    const currentShow = parseFloat(showEl.value || 0);
                    if (toMove <= currentShow) {
                        showEl.value = currentShow - toMove;
                        storageEl.value = parseFloat(storageEl.value || 0) + toMove;
                    }
                }
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory moved back!');
            closeAaronMoveBackInventoryModal();
        }

        function openPopRemoveInventoryModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`pop-remove-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('popRemoveInventoryModal').classList.add('active');
        }

        function closePopRemoveInventoryModal() {
            document.getElementById('popRemoveInventoryModal').classList.remove('active');
        }

        function addPopRemoveInventory() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const toRemove = parseFloat(document.getElementById(`pop-remove-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.pop-storage[data-product="${i}"]`);
                if (storageEl && toRemove > 0) {
                    storageEl.value = Math.max(0, parseFloat(storageEl.value || 0) - toRemove);
                }
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory removed!');
            closePopRemoveInventoryModal();
        }

        function openAaronRemoveInventoryModal() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const input = document.getElementById(`aaron-remove-${i}`);
                if (input) input.value = '';
            }
            document.getElementById('aaronRemoveInventoryModal').classList.add('active');
        }

        function closeAaronRemoveInventoryModal() {
            document.getElementById('aaronRemoveInventoryModal').classList.remove('active');
        }

        function addAaronRemoveInventory() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const toRemove = parseFloat(document.getElementById(`aaron-remove-${i}`)?.value || 0);
                const storageEl = document.querySelector(`.aaron-storage[data-product="${i}"]`);
                if (storageEl && toRemove > 0) {
                    storageEl.value = Math.max(0, parseFloat(storageEl.value || 0) - toRemove);
                }
            }
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Inventory removed!');
            closeAaronRemoveInventoryModal();
        }

        // SALES SHEETS
        function openNewSalesSheetModal() {
            document.getElementById('new-sheet-name').value = '';
            document.getElementById('newSalesSheetModal').classList.add('active');
        }

        function closeNewSalesSheetModal() {
            document.getElementById('newSalesSheetModal').classList.remove('active');
        }

        function confirmNewSalesSheet() {
            const name = document.getElementById('new-sheet-name').value.trim();
            if (!name) return alert('Sheet name is required');
            const sheetId = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            if (sheetMetadata[sheetId]) return alert('Sheet already exists');
            sheetMetadata[sheetId] = { name, person: 'pop', date: new Date().toISOString().split('T')[0] };
            sheetStates[sheetId] = { active: false, locked: false, completed: false };
            renderSalesSheets();
            updateDeleteSheetSelect();
            showSuccess('‚úÖ Sheet created!');
            closeNewSalesSheetModal();
            saveAllDataNow();
        }

        function openNewAaronSalesSheetModal() {
            document.getElementById('new-aaron-sheet-name').value = '';
            document.getElementById('newAaronSalesSheetModal').classList.add('active');
        }

        function closeNewAaronSalesSheetModal() {
            document.getElementById('newAaronSalesSheetModal').classList.remove('active');
        }

        function confirmNewAaronSalesSheet() {
            const name = document.getElementById('new-aaron-sheet-name').value.trim();
            if (!name) return alert('Sheet name is required');
            const sheetId = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            if (sheetMetadata[sheetId]) return alert('Sheet already exists');
            sheetMetadata[sheetId] = { name, person: 'aaron', date: new Date().toISOString().split('T')[0] };
            sheetStates[sheetId] = { active: false, locked: false, completed: false };
            renderSalesSheets();
            updateDeleteSheetSelect();
            showSuccess('‚úÖ Sheet created!');
            closeNewAaronSalesSheetModal();
            saveAllDataNow();
        }

        function openDeletePopSalesSheetModal() {
            updateDeleteSheetSelect();
            document.getElementById('deleteSalesSheetModal').classList.add('active');
        }

        function openDeleteAaronSalesSheetModal() {
            updateDeleteSheetSelect();
            document.getElementById('deleteSalesSheetModal').classList.add('active');
        }

        function closeDeleteSalesSheetModal() {
            document.getElementById('deleteSalesSheetModal').classList.remove('active');
        }

        function confirmDeleteSalesSheet() {
            const sheetId = document.getElementById('delete-sheet-select').value;
            if (!sheetId) return alert('Select a sheet');
            delete sheetMetadata[sheetId];
            delete sheetStates[sheetId];
            renderSalesSheets();
            updateDeleteSheetSelect();
            showSuccess('‚úÖ Sheet deleted!');
            closeDeleteSalesSheetModal();
            saveAllDataNow();
        }

        function toggleEventCompleted(sheetId) {
            const checkbox = document.getElementById(`event-completed-${sheetId}`);
            if (checkbox.checked) {
                pendingEventCompletedSheet = sheetId;
                const meta = sheetMetadata[sheetId];
                document.getElementById('confirmEventSheetName').innerText = meta?.name || sheetId;
                let totalUnits = 0, totalRevenue = 0;
                const person = meta?.person;
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                    const priceEl = document.querySelector(`.${person}-price[data-product="${i}"]`);
                    const sold = parseFloat(soldEl?.textContent || 0);
                    const price = parseFloat(priceEl?.value || 0);
                    totalUnits += sold;
                    totalRevenue += sold * price;
                }
                document.getElementById('confirmEventUnits').innerText = totalUnits;
                document.getElementById('confirmEventRevenue').innerText = '$' + totalRevenue.toFixed(2);
                document.getElementById('eventCompletedConfirmModal').classList.add('active');
                checkbox.checked = false;
            }
        }

        function closeEventCompletedConfirmModal() {
            document.getElementById('eventCompletedConfirmModal').classList.remove('active');
            pendingEventCompletedSheet = null;
        }

        function confirmEventCompleted() {
            const sheetId = pendingEventCompletedSheet;
            sheetStates[sheetId].locked = true;
            const meta = sheetMetadata[sheetId];
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                const showTubEl = document.querySelector(`.${meta.person}-show-tub[data-product="${i}"]`);
                const unitsSold = parseFloat(soldEl?.textContent || 0);
                if (showTubEl) {
                    showTubEl.value = Math.max(0, parseFloat(showTubEl.value || 0) - unitsSold);
                }
            }
            document.querySelectorAll(`.units-left[data-sheet="${sheetId}"]`).forEach(input => { input.disabled = true; });
            updateSheetStatus(sheetId);
            updateAllInventories();
            updateInventoryAggregatedUnitsSold();
            recalculateRevenueForSheet(sheetId);
            saveAllDataNow();
            showSuccess('‚úÖ Event completed!');
            closeEventCompletedConfirmModal();
        }

        function refreshSheetData(person, sheetId) {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const showEl = document.querySelector(`.${person}-show-tub[data-product="${i}"]`);
                const broughtEl = document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${i}"]`);
                if (showEl && broughtEl) broughtEl.value = parseFloat(showEl.value || 0);
            }
            showSuccess('‚úÖ Units brought refreshed!');
        }

        // ANALYTICS
        function getTopSellersData(person) {
            const salesByProduct = Array(NUM_PRODUCTS).fill(0);
            const allSheetIds = [...Object.keys(sheetMetadata)];
            allSheetIds.forEach(sheetId => {
                const meta = sheetMetadata[sheetId];
                if (meta?.person !== person || !sheetStates[sheetId]?.locked) return;
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                    if (soldEl) salesByProduct[i] += parseFloat(soldEl.textContent || 0);
                }
            });
            const total = salesByProduct.reduce((a, b) => a + b, 0);
            const sorted = salesByProduct.map((val, idx) => ({
                name: productNames[idx],
                value: val,
                percentage: total > 0 ? ((val / total) * 100).toFixed(1) : 0
            })).sort((a, b) => b.value - a.value);
            return { labels: sorted.map(x => `${x.name} (${x.percentage}%)`), data: sorted.map(x => x.value) };
        }

        function getTopRevenueData(person) {
            const revenueByProduct = Array(NUM_PRODUCTS).fill(0);
            const allSheetIds = [...Object.keys(sheetMetadata)];
            allSheetIds.forEach(sheetId => {
                const meta = sheetMetadata[sheetId];
                if (meta?.person !== person || !sheetStates[sheetId]?.locked) return;
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                    const priceEl = document.querySelector(`.${person}-price[data-product="${i}"]`);
                    const sold = parseFloat(soldEl?.textContent || 0);
                    const price = parseFloat(priceEl?.value || 0);
                    revenueByProduct[i] += sold * price;
                }
            });
            const total = revenueByProduct.reduce((a, b) => a + b, 0);
            const sorted = revenueByProduct.map((val, idx) => ({
                name: productNames[idx],
                value: val,
                percentage: total > 0 ? ((val / total) * 100).toFixed(1) : 0
            })).sort((a, b) => b.value - a.value);
            return { labels: sorted.map(x => `${x.name} (${x.percentage}%)`), data: sorted.map(x => x.value.toFixed(2)) };
        }

        function getTrendData(person) {
            const sheetsByDate = {};
            const allSheetIds = [...Object.keys(sheetMetadata)];
            allSheetIds.forEach(sheetId => {
                const meta = sheetMetadata[sheetId];
                if (!meta || meta.person !== person) return;
                if (!sheetsByDate[meta.date]) sheetsByDate[meta.date] = [];
                sheetsByDate[meta.date].push(sheetId);
            });

            const dates = Object.keys(sheetsByDate).sort();
            const datasets = [];
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#30cfd0', '#a8edea', '#fed6e3', '#ff9ff3', '#74b9ff', '#a29bfe'];
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const data = dates.map(date => {
                    let total = 0;
                    sheetsByDate[date].forEach(sheetId => {
                        if (!sheetStates[sheetId]?.locked) return;
                        const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`);
                        if (soldEl) total += parseFloat(soldEl.textContent || 0);
                    });
                    return total;
                });
                if (data.some(x => x > 0)) {
                    datasets.push({
                        label: productNames[i],
                        data: data,
                        tension: 0.3,
                        borderColor: colors[i % colors.length],
                        fill: false
                    });
                }
            }
            return { labels: dates, datasets: datasets };
        }

        function refreshAnalytics() {
            ['pop', 'aaron'].forEach(person => {
                const topSellersData = getTopSellersData(person);
                const topRevenueData = getTopRevenueData(person);
                const trendData = getTrendData(person);

                const topSellersCtx = document.getElementById(`${person}TopSellersChart`)?.getContext('2d');
                if (topSellersCtx) {
                    if (chartsInstances[`${person}TopSellers`]) chartsInstances[`${person}TopSellers`].destroy();
                    chartsInstances[`${person}TopSellers`] = new Chart(topSellersCtx, {
                        type: 'bar',
                        data: { labels: topSellersData.labels, datasets: [{ label: 'Units Sold', data: topSellersData.data, backgroundColor: '#667eea' }] },
                        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    });
                }

                const revenueCtx = document.getElementById(`${person}RevenueChart`)?.getContext('2d');
                if (revenueCtx) {
                    if (chartsInstances[`${person}Revenue`]) chartsInstances[`${person}Revenue`].destroy();
                    chartsInstances[`${person}Revenue`] = new Chart(revenueCtx, {
                        type: 'pie',
                        data: { labels: topRevenueData.labels, datasets: [{ data: topRevenueData.data, backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#30cfd0', '#a8edea', '#fed6e3', '#ff9ff3', '#74b9ff', '#a29bfe'] }] },
                        options: { responsive: true }
                    });
                }

                const trendCtx = document.getElementById(`${person}TrendChart`)?.getContext('2d');
                if (trendCtx) {
                    if (chartsInstances[`${person}Trend`]) chartsInstances[`${person}Trend`].destroy();
                    chartsInstances[`${person}Trend`] = new Chart(trendCtx, {
                        type: 'line',
                        data: trendData,
                        options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
                    });
                }
            });
        }

        // EXCEL EXPORT/IMPORT
        function exportToExcel() {
            const workbook = XLSX.utils.book_new();

            // Master Inventory sheet
            const masterData = [];
            masterData.push(['Master Inventory']);
            masterData.push(['Product Name', 'Pop Total', 'Aaron Total', 'Combined Total']);
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const popStock = parseFloat(document.querySelector(`.pop-current-stock[data-product="${i}"]`)?.value || 0);
                const aaronStock = parseFloat(document.querySelector(`.aaron-current-stock[data-product="${i}"]`)?.value || 0);
                masterData.push([productNames[i], popStock, aaronStock, popStock + aaronStock]);
            }
            XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet(masterData), 'Master Inventory');

            // Pop Inventory sheet
            const popInvData = [];
            popInvData.push(['Pop Current Inventory']);
            popInvData.push(['Product Name', 'Selling Price', 'Storage Tub', 'Show Tub', 'Units Sold (Locked)', 'Total On Hand']);
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const price = parseFloat(document.querySelector(`.pop-price[data-product="${i}"]`)?.value || 0);
                const storage = parseFloat(document.querySelector(`.pop-storage[data-product="${i}"]`)?.value || 0);
                const show = parseFloat(document.querySelector(`.pop-show-tub[data-product="${i}"]`)?.value || 0);
                const sold = parseFloat(document.querySelector(`.pop-units-sold-agg[data-product="${i}"]`)?.value || 0);
                const total = parseFloat(document.querySelector(`.pop-current-stock[data-product="${i}"]`)?.value || 0);
                popInvData.push([productNames[i], price, storage, show, sold, total]);
            }
            XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet(popInvData), 'Pop Inventory');

            // Aaron Inventory sheet
            const aaronInvData = [];
            aaronInvData.push(['Aaron Current Inventory']);
            aaronInvData.push(['Product Name', 'Selling Price', 'Storage Tub', 'Show Tub', 'Units Sold (Locked)', 'Total On Hand']);
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const price = parseFloat(document.querySelector(`.aaron-price[data-product="${i}"]`)?.value || 0);
                const storage = parseFloat(document.querySelector(`.aaron-storage[data-product="${i}"]`)?.value || 0);
                const show = parseFloat(document.querySelector(`.aaron-show-tub[data-product="${i}"]`)?.value || 0);
                const sold = parseFloat(document.querySelector(`.aaron-units-sold-agg[data-product="${i}"]`)?.value || 0);
                const total = parseFloat(document.querySelector(`.aaron-current-stock[data-product="${i}"]`)?.value || 0);
                aaronInvData.push([productNames[i], price, storage, show, sold, total]);
            }
            XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet(aaronInvData), 'Aaron Inventory');

            // Sales Sheets
            const allSheetIds = [...Object.keys(sheetMetadata)];
            allSheetIds.forEach(sheetId => {
                const meta = sheetMetadata[sheetId];
                const salesData = [];
                salesData.push([meta.name]);
                salesData.push(['Status', sheetStates[sheetId]?.locked ? 'Locked' : sheetStates[sheetId]?.active ? 'Active' : 'Inactive']);
                salesData.push(['Product Name', 'Units Brought', 'Units Sold', 'Units Left in Tub']);
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    const brought = parseFloat(document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${i}"]`)?.value || 0);
                    const sold = parseFloat(document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`)?.textContent || 0);
                    const left = parseFloat(document.querySelector(`.units-left[data-sheet="${sheetId}"][data-row="${i}"]`)?.value || 0);
                    salesData.push([productNames[i], brought, sold, left]);
                }
                const totalUnits = parseFloat(document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`)?.value || 0);
                const totalRevenue = parseFloat(document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`)?.value || 0);
                salesData.push(['TOTAL UNITS SOLD', '', totalUnits, '']);
                salesData.push(['TOTAL REVENUE', '', totalRevenue, '']);
                XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet(salesData), meta.name.substring(0, 31));
            });

            // Shrinkage sheet
            const shrinkageData = [];
            shrinkageData.push(['Shrinkage Tracking']);
            shrinkageData.push(['Date', 'Person', 'Product', 'Qty', 'From', 'Notes']);
            shrinkageLog.forEach(entry => {
                shrinkageData.push([
                    entry.date,
                    entry.person === 'pop' ? 'Pop' : 'Aaron',
                    productNames[entry.productIdx],
                    entry.qty,
                    entry.depletFrom === 'storage' ? 'Storage' : entry.depletFrom === 'show' ? 'Show Tub' : 'Both',
                    entry.notes
                ]);
            });
            XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet(shrinkageData), 'Shrinkage');

            const filename = `knife-inventory-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, filename);

            // Add to library
            const exportEntry = {
                filename: filename,
                date: new Date().toLocaleString(),
                size: 'File generated'
            };
            excelLibrary.push(exportEntry);
            saveAllDataNow();
            showSuccess('‚úÖ Excel file exported!');
        }

        function renderExcelLibrary() {
            const container = document.getElementById('excel-library-items');
            if (excelLibrary.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No exports yet. Export your data to see it here.</p>';
                return;
            }
            container.innerHTML = '';
            excelLibrary.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'excel-library-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.filename}</strong>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">${item.date}</p>
                    </div>
                    <button onclick="downloadExcel(${idx})" style="background: #2196f3; padding: 8px 12px; color: white; border: none; border-radius: 4px; cursor: pointer;">Download</button>
                `;
                container.appendChild(div);
            });
        }

        function openImportExcelModal() {
            document.getElementById('import-file').value = '';
            document.getElementById('importExcelModal').classList.add('active');
        }

        function closeImportExcelModal() {
            document.getElementById('importExcelModal').classList.remove('active');
        }

        function confirmImportExcel() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return alert('Select a file');
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    // Import logic would go here to match exported structure
                });
                showSuccess('‚úÖ Data imported!');
                closeImportExcelModal();
            };
            reader.readAsBinaryString(file);
        }

        function downloadExcel(idx) {
            alert(`Download Excel file: ${excelLibrary[idx].filename}`);
        }

        // FIREBASE SYNC
        function saveAllDataNow() {
            if (!window.firebaseReady) return;
            const data = {
                products: productNames,
                pop: [],
                aaron: [],
                sheets: {},
                sheetMetadata: sheetMetadata,
                sheetStates: sheetStates,
                shrinkageLog: shrinkageLog,
                excelLibrary: excelLibrary
            };

            for (let i = 0; i < NUM_PRODUCTS; i++) {
                data.pop.push({
                    price: parseFloat(document.querySelector(`.pop-price[data-product="${i}"]`)?.value || 0),
                    storage: parseFloat(document.querySelector(`.pop-storage[data-product="${i}"]`)?.value || 0),
                    showTub: parseFloat(document.querySelector(`.pop-show-tub[data-product="${i}"]`)?.value || 0)
                });
                data.aaron.push({
                    price: parseFloat(document.querySelector(`.aaron-price[data-product="${i}"]`)?.value || 0),
                    storage: parseFloat(document.querySelector(`.aaron-storage[data-product="${i}"]`)?.value || 0),
                    showTub: parseFloat(document.querySelector(`.aaron-show-tub[data-product="${i}"]`)?.value || 0)
                });
            }

            const allSheetIds = [...Object.keys(sheetMetadata)];
            allSheetIds.forEach(sheetId => {
                const rows = [];
                for (let i = 0; i < NUM_PRODUCTS; i++) {
                    rows.push({
                        brought: parseFloat(document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${i}"]`)?.value || 0),
                        sold: parseFloat(document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${i}"]`)?.textContent || 0),
                        left: parseFloat(document.querySelector(`.units-left[data-sheet="${sheetId}"][data-row="${i}"]`)?.value || 0)
                    });
                }
                data.sheets[sheetId] = {
                    rows: rows,
                    totalUnits: parseFloat(document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`)?.value || 0),
                    totalRevenue: parseFloat(document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`)?.value || 0)
                };
            });

            window.firebaseSet(window.firebaseRef(window.firebaseDB, 'inventoryData'), data).catch(err => console.error('Save error:', err));
        }

        function loadDataFromFirebase() {
            if (!window.firebaseReady) return;
            window.firebaseOnValue(window.firebaseRef(window.firebaseDB, 'inventoryData'), (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                if (data.products) {
                    productNames = data.products;
                    NUM_PRODUCTS = productNames.length;
                    renderMasterInventoryTable();
                    renderInventoryTables();
                    renderSalesSheets();
                    renderReceiveModals();
                    renderMoveInventoryModals();
                    renderRemoveInventoryModals();
                    renderShrinkageModal();
                }

                if (data.pop) {
                    for (let i = 0; i < Math.min(data.pop.length, NUM_PRODUCTS); i++) {
                        const item = data.pop[i] || {};
                        const priceEl = document.querySelector(`.pop-price[data-product="${i}"]`);
                        const storageEl = document.querySelector(`.pop-storage[data-product="${i}"]`);
                        const showTubEl = document.querySelector(`.pop-show-tub[data-product="${i}"]`);
                        if (priceEl) priceEl.value = item.price ?? '';
                        if (storageEl) storageEl.value = item.storage ?? 0;
                        if (showTubEl) showTubEl.value = item.showTub ?? 0;
                    }
                }

                if (data.aaron) {
                    for (let i = 0; i < Math.min(data.aaron.length, NUM_PRODUCTS); i++) {
                        const item = data.aaron[i] || {};
                        const priceEl = document.querySelector(`.aaron-price[data-product="${i}"]`);
                        const storageEl = document.querySelector(`.aaron-storage[data-product="${i}"]`);
                        const showTubEl = document.querySelector(`.aaron-show-tub[data-product="${i}"]`);
                        if (priceEl) priceEl.value = item.price ?? '';
                        if (storageEl) storageEl.value = item.storage ?? 0;
                        if (showTubEl) showTubEl.value = item.showTub ?? 0;
                    }
                }

                if (data.sheets) {
                    Object.entries(data.sheets).forEach(([sheetId, sheetData]) => {
                        if (!sheetData?.rows) return;
                        sheetData.rows.forEach((row, idx) => {
                            if (idx >= NUM_PRODUCTS) return;
                            const broughtEl = document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${idx}"]`);
                            const soldEl = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${idx}"]`);
                            const leftEl = document.querySelector(`.units-left[data-sheet="${sheetId}"][data-row="${idx}"]`);
                            if (broughtEl) broughtEl.value = row.brought ?? 0;
                            if (soldEl) soldEl.textContent = row.sold ?? 0;
                            if (leftEl) leftEl.value = row.left ?? 0;
                        });
                        const totalUnitsEl = document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`);
                        const totalRevEl = document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`);
                        if (totalUnitsEl) totalUnitsEl.value = sheetData.totalUnits ?? 0;
                        if (totalRevEl) totalRevEl.value = (sheetData.totalRevenue ?? 0).toFixed(2);
                    });
                }

                if (data.sheetMetadata) sheetMetadata = { ...sheetMetadata, ...data.sheetMetadata };
                if (data.sheetStates) sheetStates = { ...sheetStates, ...data.sheetStates };
                if (data.shrinkageLog) shrinkageLog = data.shrinkageLog;
                if (data.excelLibrary) excelLibrary = data.excelLibrary;

                updateAllInventories();
                updateInventoryAggregatedUnitsSold();
                Object.keys(sheetStates).forEach(sheetId => updateSheetStatus(sheetId));
                updateShrinkageDisplay();
                console.log('‚úÖ Firebase load complete');
            });
        }

        function resetAllData() {
            if (!confirm('‚ö†Ô∏è This will reset ALL data. Are you sure?')) return;
            productNames = ["Full Tang", "8\" Rat", "6\" Rat", "8\" Stag", "6\" Stag", "Grooved", "Folders", "Bull Cutters", "Horizontal Sheaths", "Bowies", "Mini Folders"];
            NUM_PRODUCTS = productNames.length;
            sheetMetadata = {
                "wetumpka": { name: "Wetumpka, Alabama", person: "pop", date: "2024-12-12" },
                "trussville": { name: "Trussville, Alabama", person: "pop", date: "2024-01-03" },
                "columbia": { name: "Columbia, Tennessee", person: "pop", date: "2024-01-10" },
                "hattiesburg": { name: "Hattiesburg, Mississippi", person: "pop", date: "2024-01-17" }
            };
            shrinkageLog = [];
            excelLibrary = [];
            initSheetStates();
            renderMasterInventoryTable();
            renderInventoryTables();
            renderSalesSheets();
            renderReceiveModals();
            renderMoveInventoryModals();
            renderRemoveInventoryModals();
            renderShrinkageModal();
            updateAllInventories();
            saveAllDataNow();
            showSuccess('‚úÖ Data reset!');
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
