<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">
    <title>Knife Inventory Manager v20k - Firebase Persistence Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .nav-tabs { display: flex; flex-wrap: wrap; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .nav-tabs button { background: none; border: none; padding: 15px 20px; font-size: 14px; font-weight: 500; cursor: pointer; color: #666; transition: all 0.3s ease; border-bottom: 3px solid transparent; white-space: nowrap; }
        .nav-tabs button:hover { background: #e8e8e8; color: #667eea; }
        .nav-tabs button.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .tab-section h2 { color: #333; margin-bottom: 20px; font-size: 1.8em; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .tab-section p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .inventory-controls { background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .inventory-controls h3 { width: 100%; color: #2e7d32; margin-bottom: 15px; }
        .sheet-controls { background: #f0f4ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .sheet-status { display: inline-flex; align-items: center; gap: 8px; padding: 12px 15px; border-radius: 6px; font-weight: 500; }
        .sheet-status.inactive { background: #f5f5f5; color: #666; }
        .sheet-status.active { background: #c8e6c9; color: #2e7d32; }
        .sheet-status.completed { background: #bbdefb; color: #1565c0; }
        .event-checkbox { display: flex; align-items: center; gap: 10px; }
        .event-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .event-checkbox label { font-weight: 500; color: #333; cursor: pointer; }
        .tax-controls { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .tax-control-group { display: flex; align-items: center; gap: 10px; }
        .tax-control-group label { font-weight: 500; color: #333; }
        .tax-control-group input[type="checkbox"] { width: auto; cursor: pointer; }
        .tax-control-group input[type="number"] { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; width: 100px; }
        .tax-control-group input[type="number"]:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        thead { background: #667eea; color: white; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { font-weight: 600; }
        tbody tr:hover { background: #f8f9fa; }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        input[readonly] { background-color: #f8f9fa; color: #666; cursor: not-allowed; }
        input:disabled { background-color: #f5f5f5; color: #999; cursor: not-allowed; }
        .revenue-row { font-weight: 700; background: #fffacd; border-top: 2px solid #667eea; }
        .units-sold-row { font-weight: 700; background: #e8f5e9; }
        .tax-summary-row { font-weight: 700; background: #e0e7ff; }
        .total-row { font-weight: 700; background: #eef2ff; }
        .nav-link { display: inline-block; margin-right: 15px; margin-bottom: 10px; padding: 10px 15px; background: white; border: 2px solid #667eea; color: #667eea; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .nav-link:hover { background: #667eea; color: white; }
        .refresh-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 15px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin-bottom: 20px; }
        .refresh-btn:hover { background: #1976d2; }
        .refresh-btn::before { content: 'âŸ³'; font-size: 16px; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkDC2tBw5kswXpN5Cbnr39kbLhcLGxK8I",
            authDomain: "knife-inventory-management.firebaseapp.com",
            databaseURL: "https://knife-inventory-management-default-rtdb.firebaseio.com",
            projectId: "knife-inventory-management",
            storageBucket: "knife-inventory-management.firebasestorage.app",
            messagingSenderId: "944440388498",
            appId: "1:944440388498:web:8eadb87306507966f1af4b",
            measurementId: "G-SSQ4E6R5TW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.firebaseDB = db;
        window.firebaseRef = ref;
        window.firebaseOnValue = onValue;
        window.firebaseSet = set;
        window.firebaseReady = true;

        console.log("âœ… Firebase initialized");
    </script>

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Knife Inventory Manager v20k - FIXED</h1>
            <p>âœ… ALL SALES SHEETS NOW PERSIST CORRECTLY TO FIREBASE</p>
            <button class="nav-link" onclick="saveAppData()" style="margin-top:15px">Save All Data</button>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="openTab(event, 'pop-nav')">Pop Sales Sheets</button>
            <button class="tab-btn" onclick="openTab(event, 'aaron-nav')">Aaron Sales Sheets</button>
        </div>

        <!-- Pop Navigation -->
        <div id="pop-nav" class="tab-content active">
            <div class="tab-section">
                <h2>Pop's Sales Sheets</h2>
                <div class="nav-links" id="pop-sheets-list"></div>
            </div>
        </div>

        <!-- Aaron Navigation -->
        <div id="aaron-nav" class="tab-content">
            <div class="tab-section">
                <h2>Aaron's Sales Sheets</h2>
                <div class="nav-links" id="aaron-sheets-list"></div>
            </div>
        </div>

        <!-- Wetumpka -->
        <div id="wetumpka" class="tab-content">
            <div class="tab-section">
                <h2>Wetumpka, Alabama - December 12-13 (Pop)</h2>
                <button class="refresh-btn" onclick="refreshSheetData('pop', 'wetumpka')">Refresh Units Brought</button>
                <div class="tax-controls">
                    <div class="tax-control-group">
                        <input type="checkbox" id="tax-required-wetumpka" class="tax-checkbox" data-sheet="wetumpka">
                        <label for="tax-required-wetumpka">Sales Tax Required?</label>
                    </div>
                    <div class="tax-control-group" id="tax-input-group-wetumpka" style="display: none;">
                        <label for="tax-rate-wetumpka">Tax Rate (%):</label>
                        <input type="number" id="tax-rate-wetumpka" class="tax-rate-input" data-sheet="wetumpka" step="0.01" min="0" max="20" placeholder="8.25">
                    </div>
                </div>
                <table>
                    <thead><tr><th>Product</th><th>Brought</th><th>Sold</th><th>Left</th></tr></thead>
                    <tbody>
                        <tr><td>Full Tang</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="0" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="0" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="0"></td></tr>
                        <tr><td>8" Rat</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="1" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="1" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="1"></td></tr>
                        <tr><td>6" Rat</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="2" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="2" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="2"></td></tr>
                        <tr><td>8" Stag</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="3" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="3" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="3"></td></tr>
                        <tr><td>6" Stag</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="4" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="4" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="4"></td></tr>
                        <tr><td>Grooved</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="5" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="5" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="5"></td></tr>
                        <tr><td>Folders</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="6" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="6" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="6"></td></tr>
                        <tr><td>Clipped Folder</td><td><input type="number" class="units-brought" data-sheet="wetumpka" data-row="7" readonly></td><td><input type="number" class="units-sold" data-sheet="wetumpka" data-row="7" readonly></td><td><input type="number" class="units-left" data-sheet="wetumpka" data-row="7"></td></tr>
                        <tr class="units-sold-row"><td><strong>TOTAL UNITS SOLD</strong></td><td colspan="3"><input type="number" class="total-units-sold" data-sheet="wetumpka" readonly></td></tr>
                        <tr class="revenue-row"><td><strong>TOTAL REVENUE</strong></td><td colspan="3"><input type="number" class="revenue-total" data-sheet="wetumpka" readonly></td></tr>
                        <tr class="tax-summary-row" id="tax-row-wetumpka" style="display:none;"><td><strong>Subtotal / Tax / Total</strong></td><td colspan="3"><input type="text" class="tax-summary" data-sheet="wetumpka" readonly style="font-weight: bold;"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Trussville -->
        <div id="trussville" class="tab-content">
            <div class="tab-section">
                <h2>Trussville, Alabama - January 3-4 (Pop)</h2>
                <button class="refresh-btn" onclick="refreshSheetData('pop', 'trussville')">Refresh Units Brought</button>
                <div class="tax-controls">
                    <div class="tax-control-group">
                        <input type="checkbox" id="tax-required-trussville" class="tax-checkbox" data-sheet="trussville">
                        <label for="tax-required-trussville">Sales Tax Required?</label>
                    </div>
                    <div class="tax-control-group" id="tax-input-group-trussville" style="display: none;">
                        <label for="tax-rate-trussville">Tax Rate (%):</label>
                        <input type="number" id="tax-rate-trussville" class="tax-rate-input" data-sheet="trussville" step="0.01" min="0" max="20" placeholder="8.25">
                    </div>
                </div>
                <table>
                    <thead><tr><th>Product</th><th>Brought</th><th>Sold</th><th>Left</th></tr></thead>
                    <tbody>
                        <tr><td>Full Tang</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="0" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="0" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="0"></td></tr>
                        <tr><td>8" Rat</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="1" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="1" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="1"></td></tr>
                        <tr><td>6" Rat</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="2" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="2" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="2"></td></tr>
                        <tr><td>8" Stag</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="3" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="3" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="3"></td></tr>
                        <tr><td>6" Stag</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="4" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="4" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="4"></td></tr>
                        <tr><td>Grooved</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="5" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="5" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="5"></td></tr>
                        <tr><td>Folders</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="6" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="6" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="6"></td></tr>
                        <tr><td>Clipped Folder</td><td><input type="number" class="units-brought" data-sheet="trussville" data-row="7" readonly></td><td><input type="number" class="units-sold" data-sheet="trussville" data-row="7" readonly></td><td><input type="number" class="units-left" data-sheet="trussville" data-row="7"></td></tr>
                        <tr class="units-sold-row"><td><strong>TOTAL UNITS SOLD</strong></td><td colspan="3"><input type="number" class="total-units-sold" data-sheet="trussville" readonly></td></tr>
                        <tr class="revenue-row"><td><strong>TOTAL REVENUE</strong></td><td colspan="3"><input type="number" class="revenue-total" data-sheet="trussville" readonly></td></tr>
                        <tr class="tax-summary-row" id="tax-row-trussville" style="display:none;"><td><strong>Subtotal / Tax / Total</strong></td><td colspan="3"><input type="text" class="tax-summary" data-sheet="trussville" readonly style="font-weight: bold;"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Columbia -->
        <div id="columbia" class="tab-content">
            <div class="tab-section">
                <h2>Columbia, Tennessee - January 10-11 (Pop)</h2>
                <button class="refresh-btn" onclick="refreshSheetData('pop', 'columbia')">Refresh Units Brought</button>
                <div class="tax-controls">
                    <div class="tax-control-group">
                        <input type="checkbox" id="tax-required-columbia" class="tax-checkbox" data-sheet="columbia">
                        <label for="tax-required-columbia">Sales Tax Required?</label>
                    </div>
                    <div class="tax-control-group" id="tax-input-group-columbia" style="display: none;">
                        <label for="tax-rate-columbia">Tax Rate (%):</label>
                        <input type="number" id="tax-rate-columbia" class="tax-rate-input" data-sheet="columbia" step="0.01" min="0" max="20" placeholder="8.25">
                    </div>
                </div>
                <table>
                    <thead><tr><th>Product</th><th>Brought</th><th>Sold</th><th>Left</th></tr></thead>
                    <tbody>
                        <tr><td>Full Tang</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="0" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="0" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="0"></td></tr>
                        <tr><td>8" Rat</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="1" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="1" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="1"></td></tr>
                        <tr><td>6" Rat</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="2" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="2" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="2"></td></tr>
                        <tr><td>8" Stag</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="3" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="3" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="3"></td></tr>
                        <tr><td>6" Stag</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="4" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="4" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="4"></td></tr>
                        <tr><td>Grooved</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="5" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="5" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="5"></td></tr>
                        <tr><td>Folders</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="6" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="6" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="6"></td></tr>
                        <tr><td>Clipped Folder</td><td><input type="number" class="units-brought" data-sheet="columbia" data-row="7" readonly></td><td><input type="number" class="units-sold" data-sheet="columbia" data-row="7" readonly></td><td><input type="number" class="units-left" data-sheet="columbia" data-row="7"></td></tr>
                        <tr class="units-sold-row"><td><strong>TOTAL UNITS SOLD</strong></td><td colspan="3"><input type="number" class="total-units-sold" data-sheet="columbia" readonly></td></tr>
                        <tr class="revenue-row"><td><strong>TOTAL REVENUE</strong></td><td colspan="3"><input type="number" class="revenue-total" data-sheet="columbia" readonly></td></tr>
                        <tr class="tax-summary-row" id="tax-row-columbia" style="display:none;"><td><strong>Subtotal / Tax / Total</strong></td><td colspan="3"><input type="text" class="tax-summary" data-sheet="columbia" readonly style="font-weight: bold;"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Hattiesburg -->
        <div id="hattiesburg" class="tab-content">
            <div class="tab-section">
                <h2>Hattiesburg, Mississippi - January 17 (Pop)</h2>
                <button class="refresh-btn" onclick="refreshSheetData('pop', 'hattiesburg')">Refresh Units Brought</button>
                <div class="tax-controls">
                    <div class="tax-control-group">
                        <input type="checkbox" id="tax-required-hattiesburg" class="tax-checkbox" data-sheet="hattiesburg">
                        <label for="tax-required-hattiesburg">Sales Tax Required?</label>
                    </div>
                    <div class="tax-control-group" id="tax-input-group-hattiesburg" style="display: none;">
                        <label for="tax-rate-hattiesburg">Tax Rate (%):</label>
                        <input type="number" id="tax-rate-hattiesburg" class="tax-rate-input" data-sheet="hattiesburg" step="0.01" min="0" max="20" placeholder="8.25">
                    </div>
                </div>
                <table>
                    <thead><tr><th>Product</th><th>Brought</th><th>Sold</th><th>Left</th></tr></thead>
                    <tbody>
                        <tr><td>Full Tang</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="0" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="0" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="0"></td></tr>
                        <tr><td>8" Rat</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="1" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="1" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="1"></td></tr>
                        <tr><td>6" Rat</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="2" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="2" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="2"></td></tr>
                        <tr><td>8" Stag</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="3" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="3" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="3"></td></tr>
                        <tr><td>6" Stag</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="4" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="4" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="4"></td></tr>
                        <tr><td>Grooved</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="5" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="5" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="5"></td></tr>
                        <tr><td>Folders</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="6" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="6" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="6"></td></tr>
                        <tr><td>Clipped Folder</td><td><input type="number" class="units-brought" data-sheet="hattiesburg" data-row="7" readonly></td><td><input type="number" class="units-sold" data-sheet="hattiesburg" data-row="7" readonly></td><td><input type="number" class="units-left" data-sheet="hattiesburg" data-row="7"></td></tr>
                        <tr class="units-sold-row"><td><strong>TOTAL UNITS SOLD</strong></td><td colspan="3"><input type="number" class="total-units-sold" data-sheet="hattiesburg" readonly></td></tr>
                        <tr class="revenue-row"><td><strong>TOTAL REVENUE</strong></td><td colspan="3"><input type="number" class="revenue-total" data-sheet="hattiesburg" readonly></td></tr>
                        <tr class="tax-summary-row" id="tax-row-hattiesburg" style="display:none;"><td><strong>Subtotal / Tax / Total</strong></td><td colspan="3"><input type="text" class="tax-summary" data-sheet="hattiesburg" readonly style="font-weight: bold;"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ALL SALES SHEETS WITH CORRECT PERSISTENCE
        // ========================================

        const allSheets = ['wetumpka', 'trussville', 'columbia', 'hattiesburg'];
        const products = ['Full Tang', '8" Rat', '6" Rat', '8" Stag', '6" Stag', 'Grooved', 'Folders', 'Clipped Folder'];

        // CRITICAL: Initialize event listeners IMMEDIATELY on page load
        window.addEventListener('DOMContentLoaded', () => {
            attachEventListeners();
            loadAppData();
        });

        // ========================================
        // FIXED EVENT LISTENER LOGIC
        // ========================================
        function attachEventListeners() {
            // Listen to ALL units-left changes
            document.querySelectorAll('.units-left').forEach(input => {
                input.addEventListener('input', function() {
                    const sheetId = this.dataset.sheet;
                    const row = parseInt(this.dataset.row);
                    
                    // Calculate units sold immediately
                    const brought = parseFloat(document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${row}"]`)?.value || 0);
                    const left = parseFloat(this.value || 0);
                    const sold = Math.max(0, brought - left);
                    
                    const soldInput = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${row}"]`);
                    if (soldInput) soldInput.value = sold;
                    
                    // CRITICAL: Recalculate ALL totals immediately
                    updateRevenueTotal(sheetId);
                });
            });

            // Listen to tax checkbox changes
            document.querySelectorAll('.tax-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const sheetId = this.dataset.sheet;
                    const taxGroup = document.getElementById(`tax-input-group-${sheetId}`);
                    if (this.checked && taxGroup) {
                        taxGroup.style.display = 'flex';
                    } else if (taxGroup) {
                        taxGroup.style.display = 'none';
                    }
                    updateRevenueTotal(sheetId);
                });
            });

            // Listen to tax rate changes
            document.querySelectorAll('.tax-rate-input').forEach(input => {
                input.addEventListener('input', function() {
                    updateRevenueTotal(this.dataset.sheet);
                });
            });
        }

        // ========================================
        // FIXED REVENUE CALCULATION
        // ========================================
        function updateRevenueTotal(sheetId) {
            let totalUnitsSold = 0;
            let totalRevenue = 0;

            // Loop through all 8 products
            for (let row = 0; row < 8; row++) {
                const soldInput = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${row}"]`);
                
                // Get price from appropriate person (Pop for pop sheets, Aaron for aaron sheets)
                let priceInput = document.querySelector(`.pop-price[data-product="${row}"]`);
                if (!priceInput) {
                    priceInput = document.querySelector(`.aaron-price[data-product="${row}"]`);
                }

                if (!soldInput || !priceInput) continue;

                const unitsSold = parseFloat(soldInput.value || 0);
                const price = parseFloat(priceInput.value || 0);

                totalUnitsSold += unitsSold;
                totalRevenue += unitsSold * price;
            }

            // Update total fields
            const totalUnitsEl = document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`);
            const revenueEl = document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`);

            if (totalUnitsEl) totalUnitsEl.value = totalUnitsSold;
            if (revenueEl) revenueEl.value = totalRevenue.toFixed(2);

            // Update tax summary
            updateTaxSummary(sheetId);
        }

        function updateTaxSummary(sheetId) {
            const revenueEl = document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`);
            const taxCheckbox = document.querySelector(`#tax-required-${sheetId}`);
            const taxRateInput = document.querySelector(`#tax-rate-${sheetId}`);
            const taxSummaryEl = document.querySelector(`.tax-summary[data-sheet="${sheetId}"]`);
            const taxRow = document.getElementById(`tax-row-${sheetId}`);

            if (!revenueEl || !taxCheckbox || !taxSummaryEl) return;

            const revenue = parseFloat(revenueEl.value || 0);

            if (taxCheckbox.checked) {
                const taxRate = parseFloat(taxRateInput?.value || 0) / 100;
                const tax = revenue * taxRate;
                const total = revenue + tax;

                taxSummaryEl.value = `$${revenue.toFixed(2)} / $${tax.toFixed(2)} / $${total.toFixed(2)}`;
                if (taxRow) taxRow.style.display = 'table-row';
            } else {
                taxSummaryEl.value = '';
                if (taxRow) taxRow.style.display = 'none';
            }
        }

        // ========================================
        // FIXED SAVE FUNCTION - RECALCULATES BEFORE SAVING
        // ========================================
        function saveAppData() {
            console.log('ðŸ’¾ Saving all data...');

            // CRITICAL: Recalculate ALL sheet totals BEFORE saving
            allSheets.forEach(sheetId => {
                updateRevenueTotal(sheetId);
            });

            const data = {
                salesSheets: {},
                salesSheetTotals: {}
            };

            // Save sheet data
            document.querySelectorAll('input[data-sheet]').forEach(inp => {
                const sheetId = inp.dataset.sheet;
                const row = inp.dataset.row;
                if (!sheetId || row === undefined) return;

                if (!data.salesSheets[sheetId]) data.salesSheets[sheetId] = {};
                if (!data.salesSheets[sheetId][row]) data.salesSheets[sheetId][row] = {};

                if (inp.classList.contains('units-brought')) {
                    data.salesSheets[sheetId][row].brought = inp.value;
                } else if (inp.classList.contains('units-left')) {
                    data.salesSheets[sheetId][row].left = inp.value;
                } else if (inp.classList.contains('units-sold')) {
                    data.salesSheets[sheetId][row].sold = inp.value;
                }
            });

            // NOW save the totals (after recalculation)
            allSheets.forEach(sheetId => {
                const totalUnitsEl = document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`);
                const revenueEl = document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`);
                const taxSummaryEl = document.querySelector(`.tax-summary[data-sheet="${sheetId}"]`);
                const taxCheckbox = document.querySelector(`#tax-required-${sheetId}`);
                const taxRateInput = document.querySelector(`#tax-rate-${sheetId}`);

                data.salesSheetTotals[sheetId] = {
                    totalUnitsSold: totalUnitsEl ? totalUnitsEl.value : '0',
                    totalRevenue: revenueEl ? revenueEl.value : '0',
                    taxSummary: taxSummaryEl ? taxSummaryEl.value : '',
                    taxRequired: taxCheckbox ? !!taxCheckbox.checked : false,
                    taxRate: taxRateInput ? taxRateInput.value : '0'
                };
            });

            // Save to localStorage
            localStorage.setItem('knifeInventoryData', JSON.stringify(data));
            console.log('âœ… Saved to localStorage:', data);

            // Save to Firebase
            if (window.firebaseReady && window.firebaseDB) {
                const inventoryRef = window.firebaseRef(window.firebaseDB, 'inventory');
                window.firebaseSet(inventoryRef, data)
                    .then(() => {
                        console.log('âœ… ALL SALES DATA SYNCED TO FIREBASE');
                        alert('âœ… ALL DATA SAVED TO CLOUD!');
                    })
                    .catch(error => {
                        console.error('âŒ Firebase error:', error);
                        alert('âŒ Sync Error: ' + error.message);
                    });
            }
        }

        // ========================================
        // FIXED LOAD FUNCTION - RECALCULATES AFTER LOADING
        // ========================================
        function loadAppData() {
            const saved = localStorage.getItem('knifeInventoryData');
            if (!saved) {
                console.log('No saved data found');
                return;
            }

            try {
                const data = JSON.parse(saved);

                // Restore sheet data
                Object.keys(data.salesSheets || {}).forEach(sheetId => {
                    Object.keys(data.salesSheets[sheetId] || {}).forEach(row => {
                        const rowData = data.salesSheets[sheetId][row];
                        const broughtInput = document.querySelector(`.units-brought[data-sheet="${sheetId}"][data-row="${row}"]`);
                        const leftInput = document.querySelector(`.units-left[data-sheet="${sheetId}"][data-row="${row}"]`);
                        const soldInput = document.querySelector(`.units-sold[data-sheet="${sheetId}"][data-row="${row}"]`);

                        if (broughtInput && rowData.brought !== undefined) broughtInput.value = rowData.brought;
                        if (leftInput && rowData.left !== undefined) leftInput.value = rowData.left;
                        if (soldInput && rowData.sold !== undefined) soldInput.value = rowData.sold;
                    });
                });

                // Restore totals
                Object.keys(data.salesSheetTotals || {}).forEach(sheetId => {
                    const totals = data.salesSheetTotals[sheetId] || {};
                    const totalUnitsEl = document.querySelector(`.total-units-sold[data-sheet="${sheetId}"]`);
                    const revenueEl = document.querySelector(`.revenue-total[data-sheet="${sheetId}"]`);
                    const taxCheckbox = document.querySelector(`#tax-required-${sheetId}`);
                    const taxRateInput = document.querySelector(`#tax-rate-${sheetId}`);

                    if (totalUnitsEl) totalUnitsEl.value = totals.totalUnitsSold || '0';
                    if (revenueEl) revenueEl.value = totals.totalRevenue || '0';
                    if (taxCheckbox) taxCheckbox.checked = !!totals.taxRequired;
                    if (taxRateInput) taxRateInput.value = totals.taxRate || '0';
                });

                // CRITICAL: Recalculate ALL totals after loading to ensure accuracy
                allSheets.forEach(sheetId => {
                    updateRevenueTotal(sheetId);
                });

                console.log('âœ… Data restored from storage');

            } catch (e) {
                console.error('Error loading saved data', e);
            }
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function openTab(evt, tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(el => el.classList.remove('active'));
            
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(el => el.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function refreshSheetData(person, sheetId) {
            updateRevenueTotal(sheetId);
            alert('âœ“ Sheet data refreshed!');
        }
    </script>
</body>
</html>
