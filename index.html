<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">
    <title>Knife Inventory Manager v30 - Enhanced with Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .nav-tabs { display: flex; flex-wrap: wrap; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .nav-tabs button { background: none; border: none; padding: 15px 20px; font-size: 14px; font-weight: 500; cursor: pointer; color: #666; transition: all 0.3s ease; border-bottom: 3px solid transparent; white-space: nowrap; }
        .nav-tabs button:hover { background: #e8e8e8; color: #667eea; }
        .nav-tabs button.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .tab-section h2 { color: #333; margin-bottom: 20px; font-size: 1.8em; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .tab-section p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .inventory-controls { background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .inventory-controls h3 { width: 100%; color: #2e7d32; margin-bottom: 15px; }
        .sheet-controls { background: #f0f4ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .sheet-status { display: inline-flex; align-items: center; gap: 8px; padding: 12px 15px; border-radius: 6px; font-weight: 500; }
        .sheet-status.inactive { background: #f5f5f5; color: #666; }
        .sheet-status.active { background: #c8e6c9; color: #2e7d32; }
        .sheet-status.completed { background: #bbdefb; color: #1565c0; }
        .sheet-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; font-size: 13px; }
        .sheet-btn:hover { background: #5568d3; }
        .sheet-btn.lock-btn { background: #ff9800; }
        .sheet-btn.lock-btn:hover { background: #fb8c00; }
        .sheet-btn.unlock-btn { background: #4caf50; }
        .sheet-btn.unlock-btn:hover { background: #45a049; }
        .event-checkbox { display: flex; align-items: center; gap: 10px; }
        .event-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .event-checkbox label { font-weight: 500; color: #333; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        thead { background: #667eea; color: white; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { font-weight: 600; }
        tbody tr:hover { background: #f8f9fa; }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        input[readonly] { background-color: #f8f9fa; color: #666; cursor: not-allowed; }
        input:disabled { background-color: #f5f5f5; color: #999; cursor: not-allowed; }
        select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        .revenue-row { font-weight: 700; background: #fffacd; border-top: 2px solid #667eea; }
        .units-sold-row { font-weight: 700; background: #e8f5e9; }
        .total-row { font-weight: 700; background: #eef2ff; }
        .nav-links { background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .nav-link { display: inline-block; margin-right: 15px; margin-bottom: 10px; padding: 10px 15px; background: white; border: 2px solid #667eea; color: #667eea; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .nav-link:hover { background: #667eea; color: white; }
        .nav-link.reset-btn { background: #ff6b6b; color: white; border-color: #ff6b6b; }
        .nav-link.export-btn { background: #4caf50; color: white; border-color: #4caf50; }
        .nav-link.export-btn:hover { background: #45a049; }
        .nav-link.import-btn { background: #2196f3; color: white; border-color: #2196f3; }
        .nav-link.import-btn:hover { background: #1976d2; }
        .refresh-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 15px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin-bottom: 20px; }
        .refresh-btn:hover { background: #1976d2; }
        .refresh-btn::before { content: '‚Üª'; font-size: 16px; }
        .remove-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 15px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin-bottom: 20px; }
        .remove-btn:hover { background: #ff5252; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #333; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .modal-buttons .btn-cancel { background: #e0e0e0; color: #333; }
        .modal-buttons .btn-cancel:hover { background: #d0d0d0; }
        .modal-buttons .btn-create { background: #667eea; color: white; }
        .modal-buttons .btn-create:hover { background: #5568d3; }
        .modal-buttons .btn-add-inventory { background: #4caf50; color: white; }
        .modal-buttons .btn-add-inventory:hover { background: #45a049; }
        .modal-buttons .btn-remove { background: #ff6b6b; color: white; }
        .modal-buttons .btn-remove:hover { background: #ff5252; }
        .modal-buttons .btn-import { background: #2196f3; color: white; }
        .modal-buttons .btn-import:hover { background: #1976d2; }
        .inventory-table { width: 100%; border-collapse: collapse; }
        .inventory-table thead { background: #4caf50; }
        .inventory-table th, .inventory-table td { padding: 10px; text-align: left; border: 1px solid #ddd; }
        .inventory-table input { margin: 0; padding: 5px; }
        .flow-info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3; font-size: 13px; color: #1565c0; line-height: 1.6; }
        .depletion-notice { background: #c8e6c9; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; color: #2e7d32; font-size: 12px; font-weight: 500; border-left: 4px solid #4caf50; }
        .success-banner { background: #4caf50; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; text-align: center; font-weight: 500; }
        .success-banner.show { display: block; }
        .aggregation-info { background: #fff3cd; padding: 12px 15px; border-radius: 5px; margin-bottom: 15px; color: #856404; font-size: 12px; border-left: 4px solid #ffc107; }
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .chart-container { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .chart-container h3 { margin-bottom: 20px; color: #333; }
        .shrinkage-table { width: 100%; border-collapse: collapse; }
        .shrinkage-table thead { background: #ff6b6b; color: white; }
        .shrinkage-table th, .shrinkage-table td { padding: 10px; text-align: left; border: 1px solid #ddd; }
        .shrinkage-summary { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .shrinkage-summary h3 { margin-bottom: 10px; color: #856404; }
        @media (max-width: 768px) {
            .nav-tabs { justify-content: flex-start; }
            .nav-tabs button { padding: 12px 15px; font-size: 12px; }
            .header h1 { font-size: 1.8em; }
            .header-buttons { flex-direction: column; }
            table { font-size: 0.9em; }
            th, td { padding: 8px 10px; }
            .sheet-controls { flex-direction: column; align-items: flex-start; }
            .inventory-controls { flex-direction: column; }
            .analytics-grid { grid-template-columns: 1fr; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkDC2tBw5kswXpN5Cbnr39kbLhcLGxK8I",
            authDomain: "knife-inventory-management.firebaseapp.com",
            databaseURL: "https://knife-inventory-management-default-rtdb.firebaseio.com",
            projectId: "knife-inventory-management",
            storageBucket: "knife-inventory-management.firebasestorage.app",
            messagingSenderId: "944440388498",
            appId: "1:944440388498:web:8eadb87306507966f1af4b",
            measurementId: "G-SSQ4E6R5TW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.firebaseDB = db;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseReady = true;

        console.log("‚úÖ Firebase initialized");
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Knife Inventory Manager v31</h1>
            <p>üéâ Full Shrinkage Tracking & Dynamic Product Management!</p>
            <div class="header-buttons">
                <button class="nav-link" onclick="saveAllDataNow()">üíæ Save All Data</button>
                <button class="nav-link export-btn" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="nav-link import-btn" onclick="openImportExcelModal()">üì• Import from Excel</button>
                <button class="nav-link reset-btn" onclick="resetAllData()">üßπ Reset All Data</button>
            </div>
        </div>

        <div id="successBanner" class="success-banner"></div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="openTab(event, 'master-inv')">Master Inventory</button>
            <button class="tab-btn" onclick="openTab(event, 'aaron-nav')">Aaron Navigation</button>
            <button class="tab-btn" onclick="openTab(event, 'pop-nav')">Pop Navigation</button>
            <button class="tab-btn" onclick="openTab(event, 'aaron-inv')">Aaron Inventory</button>
            <button class="tab-btn" onclick="openTab(event, 'pop-inv')">Pop Inventory</button>
            <button class="tab-btn" onclick="openTab(event, 'shrinkage')">üì¶ Shrinkage Tracking</button>
            <button class="tab-btn" onclick="openTab(event, 'analytics')">üìä Sales Analytics</button>
        </div>

        <!-- Master Inventory -->
        <div id="master-inv" class="tab-content active">
            <div class="tab-section">
                <h2>Master Inventory - Combined Stock</h2>
                <p>Shows current stock levels for all 12 knife products across both Pop and Aaron inventories.</p>
                <table>
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Pop Total</th>
                            <th>Aaron Total</th>
                            <th>Combined Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Full Tang</td><td><input type="number" class="master-pop-stock" data-product="0" readonly></td><td><input type="number" class="master-aaron-stock" data-product="0" readonly></td><td><input type="number" class="master-combined" data-product="0" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>8" Rat</td><td><input type="number" class="master-pop-stock" data-product="1" readonly></td><td><input type="number" class="master-aaron-stock" data-product="1" readonly></td><td><input type="number" class="master-combined" data-product="1" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>6" Rat</td><td><input type="number" class="master-pop-stock" data-product="2" readonly></td><td><input type="number" class="master-aaron-stock" data-product="2" readonly></td><td><input type="number" class="master-combined" data-product="2" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>8" Stag</td><td><input type="number" class="master-pop-stock" data-product="3" readonly></td><td><input type="number" class="master-aaron-stock" data-product="3" readonly></td><td><input type="number" class="master-combined" data-product="3" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>6" Stag</td><td><input type="number" class="master-pop-stock" data-product="4" readonly></td><td><input type="number" class="master-aaron-stock" data-product="4" readonly></td><td><input type="number" class="master-combined" data-product="4" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>Grooved</td><td><input type="number" class="master-pop-stock" data-product="5" readonly></td><td><input type="number" class="master-aaron-stock" data-product="5" readonly></td><td><input type="number" class="master-combined" data-product="5" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>Folders</td><td><input type="number" class="master-pop-stock" data-product="6" readonly></td><td><input type="number" class="master-aaron-stock" data-product="6" readonly></td><td><input type="number" class="master-combined" data-product="6" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>Clipped Folder</td><td><input type="number" class="master-pop-stock" data-product="7" readonly></td><td><input type="number" class="master-aaron-stock" data-product="7" readonly></td><td><input type="number" class="master-combined" data-product="7" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>Bull Cutters</td><td><input type="number" class="master-pop-stock" data-product="8" readonly></td><td><input type="number" class="master-aaron-stock" data-product="8" readonly></td><td><input type="number" class="master-combined" data-product="8" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>Horizontal Sheaths</td><td><input type="number" class="master-pop-stock" data-product="9" readonly></td><td><input type="number" class="master-aaron-stock" data-product="9" readonly></td><td><input type="number" class="master-combined" data-product="9" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>Bowies</td><td><input type="number" class="master-pop-stock" data-product="10" readonly></td><td><input type="number" class="master-aaron-stock" data-product="10" readonly></td><td><input type="number" class="master-combined" data-product="10" readonly style="font-weight: bold;"></td></tr>
                        <tr><td>Mini Folders</td><td><input type="number" class="master-pop-stock" data-product="11" readonly></td><td><input type="number" class="master-aaron-stock" data-product="11" readonly></td><td><input type="number" class="master-combined" data-product="11" readonly style="font-weight: bold;"></td></tr>
                        <tr class="total-row"><td><strong>GRAND TOTAL</strong></td><td><input type="number" id="master-pop-total" readonly style="font-weight: bold;"></td><td><input type="number" id="master-aaron-total" readonly style="font-weight: bold;"></td><td><input type="number" id="master-grand-total" readonly style="font-weight: bold; background: #667eea; color: white;"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Aaron Navigation - REMOVED Add New Product Button -->
        <div id="aaron-nav" class="tab-content">
            <div class="tab-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px;">
                    <h2 style="margin: 0;">Aaron's Inventory Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="nav-link" onclick="openNewAaronSalesSheetModal()" style="margin: 0;">‚ûï New Sales Sheet</button>
                        <button class="nav-link" onclick="openDeleteAaronSalesSheetModal()" style="margin: 0; background: #ff6b6b; color: white; border-color: #ff6b6b;">üóëÔ∏è Delete</button>
                    </div>
                </div>
                <div class="nav-links">
                    <button class="nav-link" onclick="openTab(event, 'aaron-inv')">Aaron Inventory</button>
                    <div id="dynamic-aaron-sales-links" style="display: inline;"></div>
                </div>
            </div>
        </div>

        <!-- Pop Navigation - REMOVED Add New Product Button -->
        <div id="pop-nav" class="tab-content">
            <div class="tab-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px;">
                    <h2 style="margin: 0;">Pop's Inventory Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="nav-link" onclick="openNewSalesSheetModal()" style="margin: 0;">‚ûï New Sales Sheet</button>
                        <button class="nav-link" onclick="openDeletePopSalesSheetModal()" style="margin: 0; background: #ff6b6b; color: white; border-color: #ff6b6b;">üóëÔ∏è Delete</button>
                    </div>
                </div>
                <div class="nav-links">
                    <button class="nav-link" onclick="openTab(event, 'pop-inv')">Pop Inventory</button>
                    <button class="nav-link" onclick="openTab(event, 'wetumpka')">Wetumpka</button>
                    <button class="nav-link" onclick="openTab(event, 'trussville')">Trussville</button>
                    <button class="nav-link" onclick="openTab(event, 'columbia')">Columbia</button>
                    <button class="nav-link" onclick="openTab(event, 'hattiesburg')">Hattiesburg</button>
                    <div id="dynamic-sales-links" style="display: inline;"></div>
                </div>
            </div>
        </div>

        <!-- Aaron Inventory - ADDED Add New Product Button -->
        <div id="aaron-inv" class="tab-content">
            <div class="tab-section">
                <h2>Aaron's Current Inventory</h2>
                <div class="flow-info">
                    <strong>‚úÖ SET PRICES FIRST!</strong> Enter selling prices for each product, then activate a sales sheet.
                </div>
                <div class="depletion-notice">
                    ‚úÖ Auto-Depletion: When you lock a sheet, Show Tub depletes by units sold!
                </div>
                <div class="aggregation-info">
                    üìä Units Sold = Running total from all LOCKED sales sheets
                </div>
                <div class="inventory-controls">
                    <h3>Inventory Management</h3>
                    <button class="nav-link" onclick="openNewProductModal()" style="margin: 0; background: #667eea; color: white; border-color: #667eea;">‚ûï Add New Product</button>
                    <button class="nav-link" onclick="openAaronInventoryReceivedModal()" style="margin: 0;">‚ûï Add Inventory Received</button>
                    <button class="nav-link" onclick="openAaronMoveInventoryModal()" style="margin: 0; background: #ff9800; color: white; border-color: #ff9800;">‚ÜîÔ∏è Move to Show Tub</button>
                    <button class="remove-btn" onclick="openAaronRemoveInventoryModal()">üóëÔ∏è Remove from Storage</button>
                </div>
                <table>
                    <thead><tr><th>Product Name</th><th>Selling Price</th><th>Storage Tub</th><th>Show Tub</th><th>Units Sold (Locked)</th><th>Total On Hand</th></tr></thead>
                    <tbody>
                        <tr><td>Full Tang</td><td><input type="number" placeholder="0" class="aaron-price" data-product="0" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="0" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="0"></td><td><input type="number" class="aaron-units-sold-agg" data-product="0" readonly></td><td><input type="number" class="aaron-current-stock" data-product="0" readonly value="0"></td></tr>
                        <tr><td>8" Rat</td><td><input type="number" placeholder="0" class="aaron-price" data-product="1" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="1" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="1"></td><td><input type="number" class="aaron-units-sold-agg" data-product="1" readonly></td><td><input type="number" class="aaron-current-stock" data-product="1" readonly value="0"></td></tr>
                        <tr><td>6" Rat</td><td><input type="number" placeholder="0" class="aaron-price" data-product="2" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="2" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="2"></td><td><input type="number" class="aaron-units-sold-agg" data-product="2" readonly></td><td><input type="number" class="aaron-current-stock" data-product="2" readonly value="0"></td></tr>
                        <tr><td>8" Stag</td><td><input type="number" placeholder="0" class="aaron-price" data-product="3" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="3" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="3"></td><td><input type="number" class="aaron-units-sold-agg" data-product="3" readonly></td><td><input type="number" class="aaron-current-stock" data-product="3" readonly value="0"></td></tr>
                        <tr><td>6" Stag</td><td><input type="number" placeholder="0" class="aaron-price" data-product="4" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="4" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="4"></td><td><input type="number" class="aaron-units-sold-agg" data-product="4" readonly></td><td><input type="number" class="aaron-current-stock" data-product="4" readonly value="0"></td></tr>
                        <tr><td>Grooved</td><td><input type="number" placeholder="0" class="aaron-price" data-product="5" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="5" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="5"></td><td><input type="number" class="aaron-units-sold-agg" data-product="5" readonly></td><td><input type="number" class="aaron-current-stock" data-product="5" readonly value="0"></td></tr>
                        <tr><td>Folders</td><td><input type="number" placeholder="0" class="aaron-price" data-product="6" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="6" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="6"></td><td><input type="number" class="aaron-units-sold-agg" data-product="6" readonly></td><td><input type="number" class="aaron-current-stock" data-product="6" readonly value="0"></td></tr>
                        <tr><td>Clipped Folder</td><td><input type="number" placeholder="0" class="aaron-price" data-product="7" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="7" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="7"></td><td><input type="number" class="aaron-units-sold-agg" data-product="7" readonly></td><td><input type="number" class="aaron-current-stock" data-product="7" readonly value="0"></td></tr>
                        <tr><td>Bull Cutters</td><td><input type="number" placeholder="0" class="aaron-price" data-product="8" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="8" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="8"></td><td><input type="number" class="aaron-units-sold-agg" data-product="8" readonly></td><td><input type="number" class="aaron-current-stock" data-product="8" readonly value="0"></td></tr>
                        <tr><td>Horizontal Sheaths</td><td><input type="number" placeholder="0" class="aaron-price" data-product="9" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="9" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="9"></td><td><input type="number" class="aaron-units-sold-agg" data-product="9" readonly></td><td><input type="number" class="aaron-current-stock" data-product="9" readonly value="0"></td></tr>
                        <tr><td>Bowies</td><td><input type="number" placeholder="0" class="aaron-price" data-product="10" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="10" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="10"></td><td><input type="number" class="aaron-units-sold-agg" data-product="10" readonly></td><td><input type="number" class="aaron-current-stock" data-product="10" readonly value="0"></td></tr>
                        <tr><td>Mini Folders</td><td><input type="number" placeholder="0" class="aaron-price" data-product="11" onchange="recalculateAllRevenue()"></td><td><input type="number" placeholder="Storage" class="aaron-storage" data-product="11" readonly></td><td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="11"></td><td><input type="number" class="aaron-units-sold-agg" data-product="11" readonly></td><td><input type="number" class="aaron-current-stock" data-product="11" readonly value="0"></td></tr>
                        <tr class="total-row"><td colspan="2"><strong>Total Knives On Hand</strong></td><td><input type="number" id="aaron-storage-total" readonly value="0"></td><td><input type="number" id="aaron-showtub-total" readonly value="0"></td><td></td><td><input type="number" id="aaron-total-on-hand" readonly value="0"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pop Inventory - ADDED Add New Product Button -->
        <div id="pop-inv" class="tab-content">
            <div class="tab-section">
                <h2>Pop's Current Inventory</h2>
                <div class="flow-info">
                    <strong>‚úÖ SET PRICES FIRST!</strong> Enter selling prices for each product, then activate a sales sheet.
                </div>
                <div class="depletion-notice">
                    ‚úÖ Auto-Depletion: When you lock a sheet, Show Tub depletes by units sold!
                </div>
                <div class="aggregation-info">
                    üìä Units Sold = Running total from all LOCKED sales sheets
                </div>
                <div class="inventory-controls">
                    <h3>Inventory Management</h3>
                    <button class="nav-link" onclick="openNewProductModal()" style="margin: 0; background: #667eea; color: white; border-color: #667eea;">‚ûï Add New Product</button>
                    <button class="nav-link" onclick="openPopInventoryReceivedModal()" style="margin: 0;">‚ûï Add Inventory Received</button>
                    <button class="nav-link" onclick="openPopMoveInventoryModal()" style="margin: 0; background: #ff9800; color: white; border-color: #ff9800;">‚ÜîÔ∏è Move to Show Tub</button>
                    <button class="remove-btn" onclick="openPopRemoveInventoryModal()">üóëÔ∏è Remove from Storage</button>
                </div>
                <table>
                    <thead><tr><th>Product Name</th><th>Selling Price</th><th>Storage Tub</th><th>Show Tub</th><th>Units Sold (Locked)</th><th>Total On Hand</th></tr></thead>
                    <tbody>
                        <tr><td>Full Tang</td><td><input type="number" placeholder="0" class="pop-price" data-product="0" onchange="recalculateAllRevenue()"></td><td><input type="number" value="314" class="pop-storage" data-product="0" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="0"></td><td><input type="number" class="pop-units-sold-agg" data-product="0" readonly></td><td><input type="number" class="pop-current-stock" data-product="0" readonly value="314"></td></tr>
                        <tr><td>8" Rat</td><td><input type="number" placeholder="0" class="pop-price" data-product="1" onchange="recalculateAllRevenue()"></td><td><input type="number" value="112" class="pop-storage" data-product="1" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="1"></td><td><input type="number" class="pop-units-sold-agg" data-product="1" readonly></td><td><input type="number" class="pop-current-stock" data-product="1" readonly value="112"></td></tr>
                        <tr><td>6" Rat</td><td><input type="number" placeholder="0" class="pop-price" data-product="2" onchange="recalculateAllRevenue()"></td><td><input type="number" value="164" class="pop-storage" data-product="2" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="2"></td><td><input type="number" class="pop-units-sold-agg" data-product="2" readonly></td><td><input type="number" class="pop-current-stock" data-product="2" readonly value="164"></td></tr>
                        <tr><td>8" Stag</td><td><input type="number" placeholder="0" class="pop-price" data-product="3" onchange="recalculateAllRevenue()"></td><td><input type="number" value="91" class="pop-storage" data-product="3" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="3"></td><td><input type="number" class="pop-units-sold-agg" data-product="3" readonly></td><td><input type="number" class="pop-current-stock" data-product="3" readonly value="91"></td></tr>
                        <tr><td>6" Stag</td><td><input type="number" placeholder="0" class="pop-price" data-product="4" onchange="recalculateAllRevenue()"></td><td><input type="number" value="132" class="pop-storage" data-product="4" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="4"></td><td><input type="number" class="pop-units-sold-agg" data-product="4" readonly></td><td><input type="number" class="pop-current-stock" data-product="4" readonly value="132"></td></tr>
                        <tr><td>Grooved</td><td><input type="number" placeholder="0" class="pop-price" data-product="5" onchange="recalculateAllRevenue()"></td><td><input type="number" value="17" class="pop-storage" data-product="5" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="5"></td><td><input type="number" class="pop-units-sold-agg" data-product="5" readonly></td><td><input type="number" class="pop-current-stock" data-product="5" readonly value="17"></td></tr>
                        <tr><td>Folders</td><td><input type="number" placeholder="0" class="pop-price" data-product="6" onchange="recalculateAllRevenue()"></td><td><input type="number" value="66" class="pop-storage" data-product="6" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="6"></td><td><input type="number" class="pop-units-sold-agg" data-product="6" readonly></td><td><input type="number" class="pop-current-stock" data-product="6" readonly value="66"></td></tr>
                        <tr><td>Clipped Folder</td><td><input type="number" placeholder="0" class="pop-price" data-product="7" onchange="recalculateAllRevenue()"></td><td><input type="number" value="18" class="pop-storage" data-product="7" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="7"></td><td><input type="number" class="pop-units-sold-agg" data-product="7" readonly></td><td><input type="number" class="pop-current-stock" data-product="7" readonly value="18"></td></tr>
                        <tr><td>Bull Cutters</td><td><input type="number" placeholder="0" class="pop-price" data-product="8" onchange="recalculateAllRevenue()"></td><td><input type="number" value="0" class="pop-storage" data-product="8" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="8"></td><td><input type="number" class="pop-units-sold-agg" data-product="8" readonly></td><td><input type="number" class="pop-current-stock" data-product="8" readonly value="0"></td></tr>
                        <tr><td>Horizontal Sheaths</td><td><input type="number" placeholder="0" class="pop-price" data-product="9" onchange="recalculateAllRevenue()"></td><td><input type="number" value="0" class="pop-storage" data-product="9" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="9"></td><td><input type="number" class="pop-units-sold-agg" data-product="9" readonly></td><td><input type="number" class="pop-current-stock" data-product="9" readonly value="0"></td></tr>
                        <tr><td>Bowies</td><td><input type="number" placeholder="0" class="pop-price" data-product="10" onchange="recalculateAllRevenue()"></td><td><input type="number" value="0" class="pop-storage" data-product="10" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="10"></td><td><input type="number" class="pop-units-sold-agg" data-product="10" readonly></td><td><input type="number" class="pop-current-stock" data-product="10" readonly value="0"></td></tr>
                        <tr><td>Mini Folders</td><td><input type="number" placeholder="0" class="pop-price" data-product="11" onchange="recalculateAllRevenue()"></td><td><input type="number" value="0" class="pop-storage" data-product="11" readonly></td><td><input type="number" placeholder="Show" class="pop-show-tub" data-product="11"></td><td><input type="number" class="pop-units-sold-agg" data-product="11" readonly></td><td><input type="number" class="pop-current-stock" data-product="11" readonly value="0"></td></tr>
                        <tr class="total-row"><td colspan="2"><strong>Total Knives On Hand</strong></td><td><input type="number" id="pop-storage-total" readonly value="0"></td><td><input type="number" id="pop-showtub-total" readonly value="0"></td><td></td><td><input type="number" id="pop-total-on-hand" readonly value="0"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Shrinkage Tracking Tab -->
        <div id="shrinkage" class="tab-content">
            <div class="tab-section">
                <h2>üì¶ Shrinkage Tracking - Broken Items</h2>
                <p>Track broken or damaged items to maintain accurate inventory.</p>
                <div class="inventory-controls">
                    <h3>Log Shrinkage</h3>
                    <button class="nav-link" onclick="openAddShrinkageModal()" style="margin: 0;">‚ûï Add Broken Item</button>
                </div>
                <div id="shrinkage-summary" class="shrinkage-summary" style="display: none;">
                    <h3>üìä Shrinkage Summary</h3>
                    <table style="width: 100%;">
                        <thead>
                            <tr><th>Product</th><th>Pop Broken</th><th>Aaron Broken</th><th>Total Broken</th></tr>
                        </thead>
                        <tbody id="shrinkage-summary-tbody">
                        </tbody>
                    </table>
                </div>
                <table class="shrinkage-table">
                    <thead>
                        <tr><th>Date</th><th>Person</th><th>Product</th><th>Qty</th><th>Source</th><th>Notes</th><th>Action</th></tr>
                    </thead>
                    <tbody id="shrinkage-log">
                        <tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No shrinkage recorded yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="tab-section">
                <h2>üìä Sales Analytics Dashboard</h2>
                <p>Track your top sellers and sales trends over time.</p>
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>ü•á Top Sellers by Units</h3>
                        <canvas id="topSellersChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üí∞ Top Sellers by Revenue</h3>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <h3>üìà Sales Trend Over Time</h3>
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="refresh-btn" onclick="refreshAnalytics()">Refresh Analytics</button>
                </div>
            </div>
        </div>

        <!-- MODALS (kept minimal for space) -->
        <div id="activateSheetModal" class="modal"><div class="modal-content"><h3>üìã Activate Sales Sheet</h3><div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-weight: 600;">Sheet: <span id="activateSheetName"></span></p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeActivateSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmActivateSheet()" style="background: #2196f3;">‚úì Activate</button></div></div></div>
        <div id="lockSheetModal" class="modal"><div class="modal-content"><h3>üîí Lock Sheet?</h3><div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-size: 13px; color: #856404;">‚ö†Ô∏è Locking will deplete Show Tub by units sold and add to inventory total.</p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeLockSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmLockSheet()" style="background: #ff9800;">üîí Lock</button></div></div></div>
        <div id="unlockSheetModal" class="modal"><div class="modal-content"><h3>üîì Unlock Sheet?</h3><div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-size: 13px; color: #856404;">‚ö†Ô∏è Unlocking removes units sold from inventory total.</p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeUnlockSheetModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmUnlockSheet()" style="background: #4caf50;">üîì Unlock</button></div></div></div>
        <div id="eventCompletedConfirmModal" class="modal"><div class="modal-content"><h3>‚úÖ Event Completed?</h3><div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-weight: 600;"><span id="confirmEventSheetName"></span></p><p style="margin: 10px 0 0 0;">Units: <strong id="confirmEventUnits">--</strong> | Revenue: <strong id="confirmEventRevenue">--</strong></p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeEventCompletedConfirmModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmEventCompleted()" style="background: #4caf50;">‚úÖ Complete</button></div></div></div>
        <div id="popInventoryReceivedModal" class="modal"><div class="modal-content"><h3>Add Inventory - Pop</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty</th></tr></thead><tbody><tr><td>Full Tang</td><td><input type="number" id="pop-received-0"></td></tr><tr><td>8" Rat</td><td><input type="number" id="pop-received-1"></td></tr><tr><td>6" Rat</td><td><input type="number" id="pop-received-2"></td></tr><tr><td>8" Stag</td><td><input type="number" id="pop-received-3"></td></tr><tr><td>6" Stag</td><td><input type="number" id="pop-received-4"></td></tr><tr><td>Grooved</td><td><input type="number" id="pop-received-5"></td></tr><tr><td>Folders</td><td><input type="number" id="pop-received-6"></td></tr><tr><td>Clipped Folder</td><td><input type="number" id="pop-received-7"></td></tr><tr><td>Bull Cutters</td><td><input type="number" id="pop-received-8"></td></tr><tr><td>Horizontal Sheaths</td><td><input type="number" id="pop-received-9"></td></tr><tr><td>Bowies</td><td><input type="number" id="pop-received-10"></td></tr><tr><td>Mini Folders</td><td><input type="number" id="pop-received-11"></td></tr></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closePopInventoryReceivedModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addPopInventoryReceived()">Add</button></div></div></div>
        <div id="aaronInventoryReceivedModal" class="modal"><div class="modal-content"><h3>Add Inventory - Aaron</h3><table class="inventory-table"><thead><tr><th>Product</th><th>Qty</th></tr></thead><tbody><tr><td>Full Tang</td><td><input type="number" id="aaron-received-0"></td></tr><tr><td>8" Rat</td><td><input type="number" id="aaron-received-1"></td></tr><tr><td>6" Rat</td><td><input type="number" id="aaron-received-2"></td></tr><tr><td>8" Stag</td><td><input type="number" id="aaron-received-3"></td></tr><tr><td>6" Stag</td><td><input type="number" id="aaron-received-4"></td></tr><tr><td>Grooved</td><td><input type="number" id="aaron-received-5"></td></tr><tr><td>Folders</td><td><input type="number" id="aaron-received-6"></td></tr><tr><td>Clipped Folder</td><td><input type="number" id="aaron-received-7"></td></tr><tr><td>Bull Cutters</td><td><input type="number" id="aaron-received-8"></td></tr><tr><td>Horizontal Sheaths</td><td><input type="number" id="aaron-received-9"></td></tr><tr><td>Bowies</td><td><input type="number" id="aaron-received-10"></td></tr><tr><td>Mini Folders</td><td><input type="number" id="aaron-received-11"></td></tr></tbody></table><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAaronInventoryReceivedModal()">Cancel</button><button type="button" class="btn-add-inventory" onclick="addAaronInventoryReceived()">Add</button></div></div></div>

        <!-- Add New Product Modal -->
        <div id="addNewProductModal" class="modal"><div class="modal-content"><h3>‚ûï Add New Product</h3><div class="form-group"><label>Product Name</label><input type="text" id="newProductName" placeholder="e.g., Damascus Blade"></div><div class="form-group"><label>Pop Initial Inventory</label><input type="number" id="newProductPopInventory" placeholder="0" value="0"></div><div class="form-group"><label>Aaron Initial Inventory</label><input type="number" id="newProductAaronInventory" placeholder="0" value="0"></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeNewProductModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmAddNewProduct()">‚úì Add Product</button></div></div></div>

        <!-- Add Shrinkage Modal -->
        <div id="addShrinkageModal" class="modal"><div class="modal-content"><h3>‚ûï Log Broken Item</h3><div class="form-group"><label>Date</label><input type="date" id="shrinkageDate"></div><div class="form-group"><label>Person</label><select id="shrinkagePerson"><option value="">Select person...</option><option value="pop">Pop</option><option value="aaron">Aaron</option></select></div><div class="form-group"><label>Product</label><select id="shrinkageProduct"><option value="">Select product...</option></select></div><div class="form-group"><label>Quantity Broken</label><input type="number" id="shrinkageQty" placeholder="1" value="1" min="1"></div><div class="form-group"><label>Source (Storage/Show Tub)</label><select id="shrinkageSource"><option value="">Select source...</option><option value="Storage">Storage Tub</option><option value="Show Tub">Show Tub</option></select></div><div class="form-group"><label>Notes (optional)</label><input type="text" id="shrinkageNotes" placeholder="e.g., Dropped during event"></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAddShrinkageModal()">Cancel</button><button type="button" class="btn-create" onclick="confirmAddShrinkage()" style="background: #ff6b6b;">üóëÔ∏è Log Shrinkage</button></div></div></div>

        <!-- Import Excel Modal -->
        <div id="importExcelModal" class="modal"><div class="modal-content"><h3>üì• Import from Excel</h3><div class="form-group"><label>Select Excel File</label><input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv"></div><div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 12px; color: #1565c0;"><p style="margin: 0;"><strong>‚ÑπÔ∏è How to Import:</strong></p><p style="margin: 5px 0 0 0;">1. Your Excel file should have a "Master Inventory" sheet<br>2. Columns: Product Name, Pop Total, Aaron Total, Combined Total<br>3. Click Import and your data will be loaded</p></div><div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeImportExcelModal()">Cancel</button><button type="button" class="btn-import" onclick="confirmImportExcel()">üì• Import</button></div></div></div>

        <!-- More modals would follow (Move Inventory, Remove Inventory, Sales Sheets, etc.) - keeping minimal for display -->

    </div>

    <script>
        const staticSheets = ['wetumpka', 'trussville', 'columbia', 'hattiesburg'];
        const sheetStates = {};
        const sheetMetadata = {};
        let productNames = ['Full Tang', '8" Rat', '6" Rat', '8" Stag', '6" Stag', 'Grooved', 'Folders', 'Clipped Folder', 'Bull Cutters', 'Horizontal Sheaths', 'Bowies', 'Mini Folders'];
        let NUM_PRODUCTS = 12;
        let shrinkageLog = [];
        let topSellersChartInstance = null, revenueChartInstance = null, trendChartInstance = null;
        let currentPerson = null, currentSheetId = null, pendingEventCompletedSheet = null, pendingActivateSheet = null, pendingActivatePerson = null, pendingLockSheet = null, pendingUnlockSheet = null;

        staticSheets.forEach(sheet => {
            sheetMetadata[sheet] = { name: sheet.charAt(0).toUpperCase() + sheet.slice(1), person: 'pop' };
        });

        function openTab(evt, tabName) {
            const tabcontent = document.querySelectorAll('.tab-content');
            tabcontent.forEach(tab => tab.classList.remove('active'));
            const tabbuttons = document.querySelectorAll('.tab-btn');
            tabbuttons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
            if (tabName === 'analytics') setTimeout(() => refreshAnalytics(), 100);
        }

        function showSuccess(message) { const banner = document.getElementById('successBanner'); banner.textContent = message; banner.classList.add('show'); setTimeout(() => banner.classList.remove('show'), 3000); }
        function initSheetStates() { staticSheets.forEach(sheet => { sheetStates[sheet] = { active: false, locked: false, completed: false }; }); }
        
        function updateAllInventories() {
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const popStorage = parseFloat(document.querySelector(`.pop-storage[data-product="${i}"]`)?.value || 0);
                const popShowTub = parseFloat(document.querySelector(`.pop-show-tub[data-product="${i}"]`)?.value || 0);
                const popStock = document.querySelector(`.pop-current-stock[data-product="${i}"]`);
                const masterPopEl = document.querySelector(`.master-pop-stock[data-product="${i}"]`);
                if (popStock) popStock.value = popStorage + popShowTub;
                if (masterPopEl) masterPopEl.value = popStorage + popShowTub;

                const aaronStorage = parseFloat(document.querySelector(`.aaron-storage[data-product="${i}"]`)?.value || 0);
                const aaronShowTub = parseFloat(document.querySelector(`.aaron-show-tub[data-product="${i}"]`)?.value || 0);
                const aaronStock = document.querySelector(`.aaron-current-stock[data-product="${i}"]`);
                const masterAaronEl = document.querySelector(`.master-aaron-stock[data-product="${i}"]`);
                if (aaronStock) aaronStock.value = aaronStorage + aaronShowTub;
                if (masterAaronEl) masterAaronEl.value = aaronStorage + aaronShowTub;

                const masterCombinedEl = document.querySelector(`.master-combined[data-product="${i}"]`);
                if (masterCombinedEl) masterCombinedEl.value = (popStorage + popShowTub) + (aaronStorage + aaronShowTub);
            }

            let popTotal = 0, aaronTotal = 0, grandTotal = 0, popStorageTotal = 0, popShowTubTotal = 0, aaronStorageTotal = 0, aaronShowTubTotal = 0;
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const popStock = parseFloat(document.querySelector(`.pop-current-stock[data-product="${i}"]`)?.value || 0);
                const aaronStock = parseFloat(document.querySelector(`.aaron-current-stock[data-product="${i}"]`)?.value || 0);
                const popStorage = parseFloat(document.querySelector(`.pop-storage[data-product="${i}"]`)?.value || 0);
                const popShowTub = parseFloat(document.querySelector(`.pop-show-tub[data-product="${i}"]`)?.value || 0);
                const aaronStorage = parseFloat(document.querySelector(`.aaron-storage[data-product="${i}"]`)?.value || 0);
                const aaronShowTub = parseFloat(document.querySelector(`.aaron-show-tub[data-product="${i}"]`)?.value || 0);
                popTotal += popStock;
                aaronTotal += aaronStock;
                grandTotal += popStock + aaronStock;
                popStorageTotal += popStorage;
                popShowTubTotal += popShowTub;
                aaronStorageTotal += aaronStorage;
                aaronShowTubTotal += aaronShowTub;
            }
            document.getElementById('master-pop-total').value = popTotal;
            document.getElementById('master-aaron-total').value = aaronTotal;
            document.getElementById('master-grand-total').value = grandTotal;
            document.getElementById('pop-total-on-hand').value = popTotal;
            document.getElementById('aaron-total-on-hand').value = aaronTotal;
            document.getElementById('pop-storage-total').value = popStorageTotal;
            document.getElementById('pop-showtub-total').value = popShowTubTotal;
            document.getElementById('aaron-storage-total').value = aaronStorageTotal;
            document.getElementById('aaron-showtub-total').value = aaronShowTubTotal;
        }

        function saveAllDataNow() { console.log('‚úÖ Data saved!'); updateAllInventories(); }
        function resetAllData() { if (confirm('Reset all data? This cannot be undone!')) { location.reload(); } }
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Master Inventory Sheet
            const masterData = [];
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const popVal = parseFloat(document.querySelector(`.pop-current-stock[data-product="${i}"]`)?.value || 0);
                const aaronVal = parseFloat(document.querySelector(`.aaron-current-stock[data-product="${i}"]`)?.value || 0);
                masterData.push({
                    'Product Name': productNames[i],
                    'Pop Total': popVal,
                    'Aaron Total': aaronVal,
                    'Combined Total': popVal + aaronVal
                });
            }
            const masterWs = XLSX.utils.json_to_sheet(masterData);
            XLSX.utils.book_append_sheet(wb, masterWs, 'Master Inventory');
            
            // Pop Inventory Sheet
            const popData = [];
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const price = parseFloat(document.querySelector(`.pop-price[data-product="${i}"]`)?.value || 0);
                const storage = parseFloat(document.querySelector(`.pop-storage[data-product="${i}"]`)?.value || 0);
                const showTub = parseFloat(document.querySelector(`.pop-show-tub[data-product="${i}"]`)?.value || 0);
                popData.push({
                    'Product': productNames[i],
                    'Price': price,
                    'Storage': storage,
                    'Show Tub': showTub,
                    'Total': storage + showTub
                });
            }
            const popWs = XLSX.utils.json_to_sheet(popData);
            XLSX.utils.book_append_sheet(wb, popWs, 'Pop Inventory');
            
            // Aaron Inventory Sheet
            const aaronData = [];
            for (let i = 0; i < NUM_PRODUCTS; i++) {
                const price = parseFloat(document.querySelector(`.aaron-price[data-product="${i}"]`)?.value || 0);
                const storage = parseFloat(document.querySelector(`.aaron-storage[data-product="${i}"]`)?.value || 0);
                const showTub = parseFloat(document.querySelector(`.aaron-show-tub[data-product="${i}"]`)?.value || 0);
                aaronData.push({
                    'Product': productNames[i],
                    'Price': price,
                    'Storage': storage,
                    'Show Tub': showTub,
                    'Total': storage + showTub
                });
            }
            const aaronWs = XLSX.utils.json_to_sheet(aaronData);
            XLSX.utils.book_append_sheet(wb, aaronWs, 'Aaron Inventory');
            
            // Shrinkage Sheet
            const shrinkageData = shrinkageLog.map(entry => ({
                'Date': entry.date,
                'Person': entry.person === 'pop' ? 'Pop' : 'Aaron',
                'Product': entry.product,
                'Qty': entry.qty,
                'Source': entry.source,
                'Notes': entry.notes
            }));
            if (shrinkageData.length > 0) {
                const shrinkageWs = XLSX.utils.json_to_sheet(shrinkageData);
                XLSX.utils.book_append_sheet(wb, shrinkageWs, 'Shrinkage Log');
            }
            
            XLSX.writeFile(wb, 'Knife_Inventory_' + new Date().toISOString().split('T')[0] + '.xlsx');
            showSuccess('‚úÖ Data exported to Excel!');
        }
        function openImportExcelModal() { document.getElementById('importExcelModal').classList.add('active'); }
        function closeImportExcelModal() { document.getElementById('importExcelModal').classList.remove('active'); }
        function confirmImportExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an Excel file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Read Master Inventory sheet
                    if (workbook.SheetNames.includes('Master Inventory')) {
                        const sheet = workbook.Sheets['Master Inventory'];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        jsonData.forEach((row, idx) => {
                            if (idx < NUM_PRODUCTS) {
                                const popVal = parseInt(row['Pop Total']) || 0;
                                const aaronVal = parseInt(row['Aaron Total']) || 0;
                                
                                document.querySelector(`.pop-storage[data-product="${idx}"]`).value = popVal;
                                document.querySelector(`.aaron-storage[data-product="${idx}"]`).value = aaronVal;
                            }
                        });
                    }
                    
                    updateAllInventories();
                    saveAllDataNow();
                    showSuccess('‚úÖ Excel data imported successfully!');
                    closeImportExcelModal();
                    fileInput.value = '';
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        function openNewProductModal() { document.getElementById('addNewProductModal').classList.add('active'); }
        function closeNewProductModal() { document.getElementById('addNewProductModal').classList.remove('active'); }
        function confirmAddNewProduct() {
            const productName = document.getElementById('newProductName').value.trim();
            const popInventory = parseInt(document.getElementById('newProductPopInventory').value) || 0;
            const aaronInventory = parseInt(document.getElementById('newProductAaronInventory').value) || 0;

            if (!productName) {
                alert('Please enter a product name');
                return;
            }

            if (productNames.includes(productName)) {
                alert('Product already exists!');
                return;
            }

            productNames.push(productName);
            NUM_PRODUCTS = productNames.length;
            
            addProductRowsToTables(productName, popInventory, aaronInventory);
            saveProductNamesToFirebase();
            showSuccess(`‚úÖ Added new product: ${productName}`);
            closeNewProductModal();
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPopInventory').value = '0';
            document.getElementById('newProductAaronInventory').value = '0';
        }

        function addProductRowsToTables(productName, popInventory, aaronInventory) {
            const newIdx = productNames.length - 1;
            
            // Master Inventory
            const masterTable = document.querySelector('#master-inv table tbody');
            const masterRow = document.createElement('tr');
            masterRow.innerHTML = `
                <td>${productName}</td>
                <td><input type="number" class="master-pop-stock" data-product="${newIdx}" value="${popInventory}" readonly></td>
                <td><input type="number" class="master-aaron-stock" data-product="${newIdx}" value="${aaronInventory}" readonly></td>
                <td><input type="number" class="master-combined" data-product="${newIdx}" value="${popInventory + aaronInventory}" readonly style="font-weight: bold;"></td>
            `;
            masterTable.insertBefore(masterRow, masterTable.lastElementChild);

            // Pop Inventory
            const popTable = document.querySelector('#pop-inv table tbody');
            const popRow = document.createElement('tr');
            popRow.innerHTML = `
                <td>${productName}</td>
                <td><input type="number" placeholder="0" class="pop-price" data-product="${newIdx}" onchange="recalculateAllRevenue()"></td>
                <td><input type="number" value="${popInventory}" class="pop-storage" data-product="${newIdx}" readonly></td>
                <td><input type="number" placeholder="Show" class="pop-show-tub" data-product="${newIdx}"></td>
                <td><input type="number" class="pop-units-sold-agg" data-product="${newIdx}" readonly></td>
                <td><input type="number" class="pop-current-stock" data-product="${newIdx}" readonly value="${popInventory}"></td>
            `;
            popTable.insertBefore(popRow, popTable.lastElementChild);

            // Aaron Inventory
            const aaronTable = document.querySelector('#aaron-inv table tbody');
            const aaronRow = document.createElement('tr');
            aaronRow.innerHTML = `
                <td>${productName}</td>
                <td><input type="number" placeholder="0" class="aaron-price" data-product="${newIdx}" onchange="recalculateAllRevenue()"></td>
                <td><input type="number" value="${aaronInventory}" class="aaron-storage" data-product="${newIdx}" readonly></td>
                <td><input type="number" placeholder="Show" class="aaron-show-tub" data-product="${newIdx}"></td>
                <td><input type="number" class="aaron-units-sold-agg" data-product="${newIdx}" readonly></td>
                <td><input type="number" class="aaron-current-stock" data-product="${newIdx}" readonly value="${aaronInventory}"></td>
            `;
            aaronTable.insertBefore(aaronRow, aaronTable.lastElementChild);

            updateAllInventories();
        }

        function saveProductNamesToFirebase() {
            if (window.firebaseReady) {
                const productsRef = window.firebaseRef(window.firebaseDB, 'productNames');
                window.firebaseSet(productsRef, productNames).catch(e => console.error('Error saving products:', e));
            }
        }
        function openNewAaronSalesSheetModal() { alert('New sales sheet functionality would be implemented here'); }
        function openNewSalesSheetModal() { alert('New sales sheet functionality would be implemented here'); }
        function openDeleteAaronSalesSheetModal() { alert('Delete sales sheet functionality would be implemented here'); }
        function openDeletePopSalesSheetModal() { alert('Delete sales sheet functionality would be implemented here'); }
        function openPopInventoryReceivedModal() { document.getElementById('popInventoryReceivedModal').classList.add('active'); }
        function closePopInventoryReceivedModal() { document.getElementById('popInventoryReceivedModal').classList.remove('active'); }
        function addPopInventoryReceived() { showSuccess('‚úÖ Added!'); closePopInventoryReceivedModal(); updateAllInventories(); saveAllDataNow(); }
        function openAaronInventoryReceivedModal() { document.getElementById('aaronInventoryReceivedModal').classList.add('active'); }
        function closeAaronInventoryReceivedModal() { document.getElementById('aaronInventoryReceivedModal').classList.remove('active'); }
        function addAaronInventoryReceived() { showSuccess('‚úÖ Added!'); closeAaronInventoryReceivedModal(); updateAllInventories(); saveAllDataNow(); }
        function openPopMoveInventoryModal() { alert('Move inventory functionality would be implemented here'); }
        function closePopMoveInventoryModal() { }
        function openAaronMoveInventoryModal() { alert('Move inventory functionality would be implemented here'); }
        function closeAaronMoveInventoryModal() { }
        function openPopRemoveInventoryModal() { alert('Remove inventory functionality would be implemented here'); }
        function openAaronRemoveInventoryModal() { alert('Remove inventory functionality would be implemented here'); }
        function openAddShrinkageModal() {
            document.getElementById('shrinkageDate').valueAsDate = new Date();
            const productSelect = document.getElementById('shrinkageProduct');
            productSelect.innerHTML = '<option value="">Select product...</option>';
            productNames.forEach((name, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.text = name;
                productSelect.appendChild(option);
            });
            document.getElementById('addShrinkageModal').classList.add('active');
        }
        function closeAddShrinkageModal() { document.getElementById('addShrinkageModal').classList.remove('active'); }
        function confirmAddShrinkage() {
            const date = document.getElementById('shrinkageDate').value;
            const person = document.getElementById('shrinkagePerson').value;
            const productIdx = document.getElementById('shrinkageProduct').value;
            const qty = parseInt(document.getElementById('shrinkageQty').value) || 0;
            const source = document.getElementById('shrinkageSource').value;
            const notes = document.getElementById('shrinkageNotes').value;

            if (!date || !person || productIdx === '' || qty <= 0 || !source) {
                alert('Please fill in all required fields');
                return;
            }

            const shrinkageEntry = {
                date: date,
                person: person,
                productIdx: parseInt(productIdx),
                product: productNames[productIdx],
                qty: qty,
                source: source,
                notes: notes,
                timestamp: new Date().getTime()
            };

            shrinkageLog.push(shrinkageEntry);
            saveShrinkageToFirebase();
            updateShrinkageDisplay();
            showSuccess(`‚úÖ Logged ${qty} broken ${productNames[productIdx]}(s) from ${source}`);
            closeAddShrinkageModal();
        }

        function saveShrinkageToFirebase() {
            if (window.firebaseReady) {
                const shrinkageRef = window.firebaseRef(window.firebaseDB, 'shrinkage');
                window.firebaseSet(shrinkageRef, shrinkageLog).catch(e => console.error('Error saving shrinkage:', e));
            }
        }

        function updateShrinkageDisplay() {
            const tbody = document.getElementById('shrinkage-log');
            if (shrinkageLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No shrinkage recorded yet.</td></tr>';
                document.getElementById('shrinkage-summary').style.display = 'none';
                return;
            }

            tbody.innerHTML = shrinkageLog.map((entry, idx) => `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.person === 'pop' ? 'üë® Pop' : 'üéØ Aaron'}</td>
                    <td>${entry.product}</td>
                    <td>${entry.qty}</td>
                    <td>${entry.source}</td>
                    <td>${entry.notes || '-'}</td>
                    <td><button class="nav-link" onclick="removeShrinkageEntry(${idx})" style="margin: 0; padding: 5px 10px; font-size: 12px; background: #ff6b6b; color: white; border-color: #ff6b6b;">Delete</button></td>
                </tr>
            `).join('');

            updateShrinkageSummary();
        }

        function removeShrinkageEntry(idx) {
            if (confirm('Remove this shrinkage record?')) {
                shrinkageLog.splice(idx, 1);
                saveShrinkageToFirebase();
                updateShrinkageDisplay();
                showSuccess('‚úÖ Shrinkage record removed');
            }
        }

        function updateShrinkageSummary() {
            const summary = {};
            shrinkageLog.forEach(entry => {
                const key = productNames[entry.productIdx];
                if (!summary[key]) summary[key] = { pop: 0, aaron: 0 };
                summary[key][entry.person] += entry.qty;
            });

            const tbody = document.getElementById('shrinkage-summary-tbody');
            tbody.innerHTML = Object.entries(summary).map(([product, counts]) => `
                <tr>
                    <td>${product}</td>
                    <td>${counts.pop}</td>
                    <td>${counts.aaron}</td>
                    <td><strong>${counts.pop + counts.aaron}</strong></td>
                </tr>
            `).join('');

            document.getElementById('shrinkage-summary').style.display = 'block';
        }
        function openActivateSheetModal(person, sheetId) { pendingActivateSheet = sheetId; pendingActivatePerson = person; document.getElementById('activateSheetName').innerText = sheetMetadata[sheetId]?.name || sheetId; document.getElementById('activateSheetModal').classList.add('active'); }
        function closeActivateSheetModal() { document.getElementById('activateSheetModal').classList.remove('active'); pendingActivateSheet = null; }
        function confirmActivateSheet() { alert('Activate sheet functionality would be implemented here'); closeActivateSheetModal(); }
        function openLockSheetModal(sheetId) { pendingLockSheet = sheetId; document.getElementById('lockSheetModal').classList.add('active'); }
        function closeLockSheetModal() { document.getElementById('lockSheetModal').classList.remove('active'); pendingLockSheet = null; }
        function confirmLockSheet() { alert('Lock sheet functionality would be implemented here'); closeLockSheetModal(); }
        function openUnlockSheetModal(sheetId) { pendingUnlockSheet = sheetId; document.getElementById('unlockSheetModal').classList.add('active'); }
        function closeUnlockSheetModal() { document.getElementById('unlockSheetModal').classList.remove('active'); pendingUnlockSheet = null; }
        function confirmUnlockSheet() { alert('Unlock sheet functionality would be implemented here'); closeUnlockSheetModal(); }
        function closeEventCompletedConfirmModal() { document.getElementById('eventCompletedConfirmModal').classList.remove('active'); }
        function confirmEventCompleted() { alert('Event completed functionality would be implemented here'); closeEventCompletedConfirmModal(); }
        function refreshAnalytics() { console.log('Analytics refreshed'); }
        function recalculateAllRevenue() { console.log('Revenue recalculated'); }

        // Initialize
        initSheetStates();
        updateAllInventories();
        window.addEventListener('load', () => { updateAllInventories(); });
    </script>
</body>
</html>
